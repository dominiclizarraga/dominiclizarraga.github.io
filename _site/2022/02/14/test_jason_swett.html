<!doctype html>
<html lang=en>
<head>
  <script>
    // Set theme immediately to prevent flash
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
      } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
  <meta charset=utf-8>
  <meta name=author content='dom lizarraga' />
  <meta name='theme-color' content='#fff' />
  <meta name='twitter:title' content="The Beginner’s Guide to Rails Testing Jason Swett" />
  <meta name=description content="" />
  <meta name=viewport content='width=device-width,minimum-scale=1'>
  <meta property='og:site_name' content="dominiclizarraga.github.io"/>
  <meta property='og:email' content="dominiclizarraga@hotmail.com"/>
  <meta property='og:type' content=blog content="domlizarrraga" />
  <meta property='twitter:account_id' content=domlizarraga_ />
  
  
  <script type='application/ld+json'>{"@context": "http://schema.org","@type": "CreativeWork","author": "dom lizarraga"}</script>
  
    <link rel=alternate type='application/rss+xml' title="dominiclizarraga.github.io - Reading" href="http://localhost:4000/reading/rss.xml" />
    <link rel=alternate type='application/atom+xml' title="dominiclizarraga.github.io - Reading" href="http://localhost:4000/reading/atom.xml" />
  
  <link rel=icon type=image/x-icon href=/css/favicon.png />
  <style>:root {
  --mono-font: San Francisco Mono, Monaco, "Consolas", "Lucida Console",
    "DejaVu Sans Mono", "Bitstream Vera Sans Mono", monospace;
  --sans-font: -apple-system, BlinkMacSystemFont, "avenir next", avenir,
    helvetica, "helvetica neue", ubuntu, roboto, noto, "segoe ui", arial,
    sans-serif;

  /* Light mode colors */
  --bg-color: #f8f5d5;
  --text-color: #111;
  --text-muted: #333;
  --text-subtle: #475569;
  --link-color: #000;
  --link-visited: #333;
  --code-bg: #fff;
  --border-color: #cfcfcf;
  --hr-color: #000;
  --input-bg: #fff;
  --input-border: rgb(133, 134, 133);
  --quote-bg: #f9f9f9;
  --header-border: #000;
  --project-link: #666;
  --project-link-hover: #000;
}

[data-theme="dark"] {
  --bg-color: #232529;
  --text-color: #d6d6d6;
  --text-muted: #b0b0b0;
  --text-subtle: #9ca3af;
  --link-color: #b68b82;
  --link-visited: #9a756d;
  --code-bg: #2d2d2d;
  --border-color: #404040;
  --hr-color: #505050;
  --input-bg: #2d2d2d;
  --input-border: #505050;
  --quote-bg: #2a2a2e;
  --header-border: #404040;
  --project-link: #9ca3af;
  --project-link-hover: #b68b82;
  --accent-color: #b68b82;
}

/* Respect system preference */
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) {
    --bg-color: #232529;
    --text-color: #d6d6d6;
    --text-muted: #b0b0b0;
    --text-subtle: #9ca3af;
    --link-color: #b68b82;
    --link-visited: #9a756d;
    --code-bg: #2d2d2d;
    --border-color: #404040;
    --hr-color: #505050;
    --input-bg: #2d2d2d;
    --input-border: #505050;
    --quote-bg: #2a2a2e;
    --header-border: #404040;
    --project-link: #9ca3af;
    --project-link-hover: #b68b82;
    --accent-color: #b68b82;
  }
}

.star {
  width: 13px;
  height: 12px;
  display: inline-block;
  background-color: var(--text-color);
  -webkit-mask: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTMiIGhlaWdodD0iMTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTYuMzA5IDkuMjJMMi40MDkgMTJsMS40NC00LjU2N0wwIDQuNTgzbDQuNzg4LS4wNDJMNi4zMDggMCA3LjgzIDQuNTRsNC43ODkuMDQ0LTMuODUgMi44NDlMMTAuMjA5IDEyeiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+") no-repeat center;
  mask: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTMiIGhlaWdodD0iMTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTYuMzA5IDkuMjJMMi40MDkgMTJsMS40NC00LjU2N0wwIDQuNTgzbDQuNzg4LS4wNDJMNi4zMDggMCA3LjgzIDQuNTRsNC43ODkuMDQ0LTMuODUgMi44NDlMMTAuMjA5IDEyeiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+") no-repeat center;
}

[data-theme="dark"] .star {
  background-color: #b68b82;
}

body {
  color: var(--text-color);
  margin: 0px auto;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  line-height: 1.6;
  font-size: 1rem;
  font-family: var(--sans-font);
  background-color: var(--bg-color);
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Print tweaks ------------------------------------------------------------- */
.only-print {
  display: none;
}

.notitle .body p:first-child {
  margin-top: 0.25rem;
}

.body img {
  width: 100%;
  max-width: 640px;
}

/* Element styles ----------------------------------------------------------- */
sup,
sub {
  vertical-align: baseline;
  position: relative;
  top: -0.4em;
}

sub {
  top: 0.4em;
}

a {
  color: var(--link-color);
  text-decoration-skip-ink: auto;
  text-decoration: underline;
}

a:visited {
  color: var(--link-visited);
}

ol,
ul {
  margin: 1rem 0;
}

ul ul {
  margin: 0;
}

ol li ul {
  margin: 5px 10px;
}

iframe {
  border: 0;
}

small,
.small {
  font-size: 14px;
}

br {
  line-height: 1em;
}

h1 a {
  color: var(--text-color);
}

em {
  font-style: italic;
}

h1 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 32px;
  letter-spacing: 0.004em;
}

h2 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1.5rem;
  letter-spacing: 0.009em;
}

h3 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1.25rem;
  letter-spacing: 0.009em;
}

h4 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1rem;
}

h5 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 0.875rem;
}

p {
  margin: 1rem 0;
}

blockquote {
  font-size: 16px;
  line-height: 25px;
}

td {
  vertical-align: top;
}

hr {
  background: var(--hr-color);
  height: 1px;
  border: 0;
}

summary {
  cursor: pointer;
}

.body table {
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
}

.body th {
  text-align: left;
}

.body td,
.body th {
  padding: 0.5rem;
}

.body td {
  border: 1px solid var(--border-color);
}

.limiter {
  max-width: 640px;
  padding-left: 20px;
  padding-right: 20px;
  margin-left: auto;
  margin-right: auto;
}

/* Padding --------------------------------------- */
.pad2y {
  padding-top: 20px;
  padding-bottom: 20px;
}

span.image-credit {
  float: right;
  margin: 0 0 10px 10px;
  font-size: 12px;
}

span.image-credit:before {
  content: "↑";
  margin-right: 5px;
}

figcaption {
  font-size: 11px;
  text-align: center;
  font-size: 0.8rem;
  margin-top: -1.2rem;
}

div.post blockquote p {
  margin: 0;
}

/** Writing ----------------------------------------------------------------- */
.writing,
.books {
  display: grid;
  grid-column-gap: 5px;
  grid-row-gap: 5px;
}

.writing {
  grid-template-columns: 1fr min-content;
}

.books {
  grid-template-columns: 1fr 0.75fr min-content 70px;
}

.writing a,
.books a {
  font-weight: 500;
  letter-spacing: -0.015em;
}

.writing > div,
.books > div {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.writing time,
.books time {
  padding-right: 0.25em;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.012em;
  white-space: pre;
}

.project-box {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-gap: 30px;
}

.project-box a.project {
  text-decoration: none;
  color: var(--project-link);
}
.project-box a.project:hover {
  color: var(--project-link-hover);
}
.project-box a.project img {
  display: block;
  margin-bottom: 10px;
  border-radius: 0.375rem;
  height: 160px;
  object-fit: cover;
}

/** Responsive -------------------------------------------------------------- */

/* Screen width:  0px -------- 480px -------- 640px -------- 1024px -------- ∞ */
/* max-width: 480px:  |←――――――| */
/* max-width: 640px:  |←―――――――――――――| */
/* min-width: 640px:                    |――――――――――――――――――――――――――――→| */
/* max-width: 1024px: |←――――――――――――――――――――――――――| */

@media screen and (max-width: 480px) {
  .project-box {
    grid-template-columns: repeat(1, 1fr);
  }
}

@media screen and (max-width: 640px) {
  .limiter {
    width: auto;
  }
  .project-box {
    grid-template-columns: repeat(2, 1fr);
  }
  .writing,
  .books {
    grid-template-columns: 1fr;
    grid-row-gap: 0px;
  }

  .writing div,
  .books div {
    white-space: normal;
  }

  .writing time,
  .books div:nth-child(4n) {
    padding-bottom: 20px;
  }
}

@media screen and (min-width: 640px) {
  .nu a {
    text-decoration: none;
  }

  .nu a:hover {
    text-decoration: underline;
  }
}

@media screen and (max-width: 1024px) {
  .header-wrap {
    border-bottom: 1px solid var(--header-border);
    padding-bottom: 10px;
  }

  .sigil {
    display: none;
  }
  /* this css if for containing search result in mobile */
  #lunrsearchresults {
    width: 350px !important;
    overflow-x: hidden;
  }

  .about-image{
    margin-top: 5px;
  }

  .project-box {
    margin-top: 5px;
    margin-bottom: 20px;
  }
}

@media screen and (min-width: 1025px) {
  .header {
    position: absolute;
    /* top: 40px; */
    right: 50%;
    margin-right: 340px !important;
    letter-spacing: -0.009em;
  }
  .content h1:first-child {
    margin-top: 0;
  }
}

@media print {
  .no-print {
    display: none;
  }
  .only-print {
    display: block;
  }
  body {
    margin: 0;
  }
  .limiter {
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
}

/** Code highlighting ------------------------------------------------------- */
p code,
pre code,
li code,
g.highlight,
.code {
  font-family: var(--mono-font);
}

p code {
  font-size: 90%;
}

pre code {
  font-size: 0.8rem;
  line-height: 1.5;
}

.highlight,
blockquote {
  overflow-x: auto;
  padding: 10px 20px;
  margin: 0;
  background: var(--code-bg);
  border-radius: 10px;
}

blockquote {
  font-style: italic;
}

blockquote p:first-child {
  margin-top: 0;
}

blockquote p:last-child {
  margin-bottom: 0;
}

/* pygments theme. does not support generics. .highlight class omitted */
.highlight {
  margin: 10px 0;
}

.highlight .hll {
  background-color: #ffffcc;
}

.c, /* Comment */
.cm, /* Comment.Multiline */
.cp, /* Comment.Preproc */
.cs, /* Comment.Special */
.c1 {
  color: #999988;
} /* Comment.Single */

.o, /* Operator */
.ow, /* Operator.Word */
.ge {
  color: #000000;
} /* Generic.Emph */

.kc, /* Keyword.Constant */
.kd, /* Keyword.Declaration */
.kn, /* Keyword.Namespace */
.kp, /* Keyword.Pseudo */
.kr, /* Keyword.Reserved */
.kt {
  color: #445588;
} /* Keyword.Type */

.err {
  color: #a61717;
} /* Error */

.m {
  color: #007f7f;
} /* Literal.Number */
.s {
  color: #d01040;
} /* Literal.String */

.na, /* Name.Attribute */
.nb, /* Name.Builtin */
.nc, /* Name.Class */
.no, /* Name.Constant */
.nd, /* Name.Decorator */
.ni, /* Name.Entity */
.ne, /* Name.Exception */
.nf, /* Name.Function */
.nn, /* Name.Namespace */
.nt, /* Name.Tag */
.nl {
  color: #990000;
} /* Name.Label */

.k, /* Keyword */
.nv {
  color: #008080;
} /* Name.Variable */

.mf, /* Literal.Number.Float */
.mh, /* Literal.Number.Hex */
.mi, /* Literal.Number.Integer */
.mo {
  color: #009999;
} /* Literal.Number.Oct */

.sb, /* Literal.String.Backtick */
.sc, /* Literal.String.Char */
.sd, /* Literal.String.Doc */
.s2, /* Literal.String.Double */
.se, /* Literal.String.Escape */
.sh, /* Literal.String.Heredoc */
.s1, /* Literal.String.Single */
.si, /* Literal.String.Interpol */
.ss, /* Literal.String.Symbol */
.bp, /* Name.Builtin.Pseudo */
.sx {
  color: #d01040;
} /* Literal.String.Other */

.sr, /* Literal.String.Regex */
.vc, /* Name.Variable.Class */
.vg, /* Name.Variable.Global */
.vi, /* Name.Variable.Instance */
.il {
  color: #009999;
} /* Literal.Number.Integer.Long */

/** Code for buy me a coffe mobile version ------------------------------------------------------- */

.mobile-only-button {
  margin-top: 30px;
  display: none;
}

@media screen and (max-width: 480px) {
  .mobile-only-button {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 50px;
  }
  
  /* Style for the generated iframe */
  .mobile-only-button iframe {
    margin: 0 auto;
  }
}

/** Code for styling reading time ------------------------------------------------------- */

.reading-time {
  color: var(--text-subtle);
  text-align: right;
  font-style: italic;
}

/** Code for footer + RSS svg ------------------------------------------------------- */

.personal-elements-container, a[rel="nofollow"], .rss-text {
  color: var(--text-subtle);
  font-style: italic;
  display: flex;
  /* align-items: center; */
  flex-direction: column;
  gap: 10px;
}

.rss-link {
  display: flex;
  align-items: flex-end;
}

/** Code for search bar ------------------------------------------------------- */

.search-bar-desktop {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-end;
  padding: 10px 20px;
  gap: 10px;
}

.search-wrapper {
  display: flex;
  align-items: center;
}

.search-form {
  margin: 0;
}

.search-input {
  border: 1px solid var(--input-border);
  padding: 8px 12px;
  background-color: var(--input-bg);
  color: var(--text-color);
  width: 200px;
  border-radius: 4px;
  font-size: 0.875rem;
  transition: border-color 0.2s, width 0.2s, background-color 0.3s;
}

.search-input:focus {
  border-color: var(--text-muted);
  outline: none;
  width: 280px;
}

/** Code for search results ------------------------------------------------------- */

.search-results {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  width: 500px;
  max-width: 90vw;
  max-height: 70vh;
  overflow-y: auto;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: none;
}

.search-results.has-results {
  display: block;
}

.search-results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-color);
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text-muted);
}

.search-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-muted);
  padding: 0;
  line-height: 1;
}

.search-close:hover {
  color: var(--text-color);
}

.search-results-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.search-result-item {
  border-bottom: 1px solid var(--border-color);
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item a {
  display: block;
  padding: 12px 16px;
  text-decoration: none;
  color: var(--text-color);
  transition: background-color 0.15s;
}

.search-result-item a:hover {
  background-color: var(--quote-bg);
}

.search-result-title {
  display: block;
  font-weight: 500;
  margin-bottom: 4px;
  color: var(--link-color);
}

.search-result-body {
  display: block;
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.4;
}

.search-result-item.no-results {
  padding: 16px;
  color: var(--text-muted);
  text-align: center;
}

.search-loading {
  padding: 16px;
  color: var(--text-muted);
  text-align: center;
  font-style: italic;
}

.search-error {
  padding: 16px;
  color: #d00;
  text-align: center;
}

@media screen and (max-width: 640px) {
  .search-results {
    left: 50%;
    transform: translateX(-50%);
    width: 95vw;
  }

  .search-input {
    width: 140px;
  }

  .search-input:focus {
    width: 160px;
  }
}

strong {
  margin-bottom: 1rem;
  display: block;
}

/** CSS style for authors quotes in 99 bottles book notes ------------------------------------------------------- */

.quote-box {
  margin: 20px auto;
  padding: 8px 10px;
  max-width: 600px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  background-color: var(--quote-bg);
  text-align: center;
  font-size: 14px;
}

/* Theme toggle button */
.theme-toggle {
  background: none;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  cursor: pointer;
  padding: 6px 10px;
  font-size: 0.7rem;
  font-family: var(--mono-font);
  color: var(--text-muted);
  transition: all 0.2s;
  text-transform: lowercase;
  letter-spacing: 0.02em;
}

.theme-toggle:hover {
  border-color: var(--text-color);
  color: var(--text-color);
}

.theme-toggle:active {
  transform: scale(0.95);
}

/* Back to top button */
.back-to-top {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 44px;
  height: 44px;
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s, transform 0.2s;
  z-index: 100;
  color: var(--text-muted);
}

.back-to-top.visible {
  opacity: 1;
  visibility: visible;
}

.back-to-top:hover {
  border-color: var(--text-color);
  color: var(--text-color);
  transform: translateY(-2px);
}

.back-to-top:active {
  transform: translateY(0);
}

@media screen and (max-width: 640px) {
  .back-to-top {
    bottom: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
  }
}</style>
  <title>The Beginner’s Guide to Rails Testing Jason Swett - dominiclizarraga.github.io</title>
  
  <link rel="canonical" href="http://localhost:4000/2022/02/14/test_jason_swett.html">
  <!-- <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="domlizarrraga" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script> -->
</head>
<body>
  <div class="limiter search-bar-desktop">
    <div class="search-wrapper">
  <form class="search-form" onSubmit="return initSearchAndQuery(document.getElementById('lunrsearch').value);">
    <input
      type="text"
      class="search-input"
      id="lunrsearch"
      name="q"
      maxlength="120"
      placeholder="Search"
    />
  </form>
</div>

<div id="lunrsearchresults" class="search-results"></div>

<script>
var searchIndex = null;
var searchDocuments = null;
var lunrLoaded = false;

function loadLunr(callback) {
  if (lunrLoaded) {
    callback();
    return;
  }
  var script = document.createElement('script');
  script.src = '/js/lunr.js';
  script.onload = function() {
    lunrLoaded = true;
    callback();
  };
  document.head.appendChild(script);
}

function loadSearchIndex(callback) {
  if (searchDocuments) {
    callback();
    return;
  }
  fetch('/search-index.json')
    .then(function(response) { return response.json(); })
    .then(function(data) {
      searchDocuments = data;
      callback();
    })
    .catch(function(err) {
      console.error('Failed to load search index:', err);
      document.getElementById('lunrsearchresults').innerHTML = '<p class="search-error">Search unavailable</p>';
    });
}

function buildIndex() {
  if (searchIndex) return;
  searchIndex = lunr(function () {
    this.ref('id');
    this.field('title', { boost: 10 });
    this.field('body');
    var self = this;
    searchDocuments.forEach(function (doc) {
      self.add(doc);
    });
  });
}

function performSearch(term) {
  var resultsEl = document.getElementById('lunrsearchresults');

  if (!term) {
    resultsEl.innerHTML = '';
    resultsEl.classList.remove('has-results');
    return false;
  }

  var results = searchIndex.search(term);

  var html = '<div class="search-results-header">Results for "' + term + '"';
  html += '<button class="search-close" onclick="closeSearch()">&times;</button></div>';
  html += '<ul class="search-results-list">';

  if (results.length > 0) {
    for (var i = 0; i < results.length; i++) {
      var ref = results[i]['ref'];
      var doc = searchDocuments.find(function(d) { return d.id == ref; });
      if (doc) {
        var body = doc.body.substring(0, 120) + '...';
        html += '<li class="search-result-item">';
        html += '<a href="' + doc.url + '">';
        html += '<span class="search-result-title">' + doc.title + '</span>';
        html += '<span class="search-result-body">' + body + '</span>';
        html += '</a></li>';
      }
    }
  } else {
    html += '<li class="search-result-item no-results">No results found</li>';
  }

  html += '</ul>';
  resultsEl.innerHTML = html;
  resultsEl.classList.add('has-results');
  return false;
}

function closeSearch() {
  var resultsEl = document.getElementById('lunrsearchresults');
  resultsEl.innerHTML = '';
  resultsEl.classList.remove('has-results');
  document.getElementById('lunrsearch').value = '';
}

function initSearchAndQuery(term) {
  var resultsEl = document.getElementById('lunrsearchresults');
  resultsEl.innerHTML = '<p class="search-loading">Searching...</p>';
  resultsEl.classList.add('has-results');

  loadLunr(function() {
    loadSearchIndex(function() {
      buildIndex();
      performSearch(term);
    });
  });
  return false;
}
</script>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode" title="Toggle dark mode">
      <span class="theme-icon">dark</span>
    </button>
  </div>
  <div class='' style='position:relative'>
    
    <div class='only-print'>
      <h2>dom lizarraga</h2>
      <div style='margin-top:0;'>dominiclizarraga@hotmail.com</div>
    </div>
    <nav class='header-wrap'>
      <div class='header nu limiter no-print'>
        <h1 style='line-height:1.6;font-size:1rem;margin:0 0 0.25em 0;'>dom lizarraga</h1>
        <ul style='list-style:none;padding:0;margin:0;'>
          <li style='margin:0.5rem 0;'><a href='/'>Notes</a></li>
          <li style='margin:0.5rem 0;'><a href='/reading/'>Reading</a>⇠</li>
          <li style='margin:0.5rem 0;'><a href='/projects/'>Projects</a></li>
          <li style='margin:0.5rem 0;'><a href='/computer-science/'>Computer <br>Science</a></li>
          <li style='margin:0.5rem 0;'><a href='/pood/'>Object-Oriented <br>Design</a></li>          <li style='margin:0.5rem 0;'><a href='/confs/'>Confs</a></li>
          <li style='margin:0.5rem 0;'><a href='/about/'>About</a></li>
        </ul>
      </div>
    </nav>
    <div class='limiter content '>
      <nav class="post-nav">
  <a href="javascript:history.back()" class="no-underline back-link" aria-label="Go back one page">
    <i aria-hidden="true">←</i>
    <span class="underline">Back one page</span>
  </a>
</nav>


<div itemscope itemtype="http://schema.org/Review">

<h1 style='font-size: 30px;'>
I read The Beginner’s Guide to Rails Testing Jason Swett by Jason Swett.
on <span itemprop="datePublished" datetime="2022-02-14">February 14, 2022</span>
</h1>


<h3 itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating">Review
  <meta itemprop="worstRating" content="1">
  <meta itemprop="ratingValue" content="5.0">
  <meta itemprop="bestRating" content="5">
  <div
    class='star'
    class='value-title'
    title='5.0'
    style='margin-left:10px;display:inline-block;background-size:15px 14px;height:14px;width: 75.0px'></div>
</h3>

<div itemprop="description" class='body'><p>Here I wrote the parts I considered most important from this book, Jason goes from explaining different types of tests, which ones he uses, DSL, how to think on testing from a specification perspective not validation, make testing a habit that compound down the road and increase productivity even though it feels in the begining that it deters you from coding faster.</p>

<ol>
  <li><a href="#chapter-1">Introduction</a></li>
  <li><a href="#chapter-2">Intro to Testing Principles</a></li>
  <li><a href="#chapter-3">Rails Testing Tools</a></li>
  <li><a href="#chapter-4">Your First Practice Tests</a></li>
  <li><a href="#chapter-14">Factory Bot: Introduction</a></li>
  <li><a href="#chapter-15">Factory Bot: Getting Started</a></li>
  <li><a href="#chapter-16">Factory Bot: Build Strategies and Faker</a></li>
  <li><a href="#chapter-17">Factory Bot: Advanced Usage</a></li>
  <li><a href="#chapter-18">RSpec Syntax: Introduction</a></li>
  <li><a href="#chapter-19">RSpec Syntax: The Structure of a Test</a></li>
  <li><a href="#chapter-20">RSpec Syntax: Let, Let! and Instance Variables</a></li>
  <li><a href="#chapter-21">RSpec Syntax: The Parts of an RSpec Test</a></li>
  <li><a href="#chapter-22">RSpec Syntax: Build Your Own RSpec, Part 1</a></li>
  <li><a href="#chapter-23">RSpec Syntax: Build Your Own RSpec, Part 2</a></li>
  <li><a href="#chapter-24">RSpec Syntax: Describe and Contex</a></li>
  <li><a href="#chapter-31">Model specs: Introduction</a></li>
  <li><a href="#chapter-32">Model specs: Tutorial, Part One</a></li>
  <li><a href="#chapter-33">Model Specs: Tutorial, Part Two</a></li>
</ol>

<h3 id="chapter-1">Chapter 1 Introduction</h3>

<p>Who this book is for, what’s in this book and how to use this book</p>

<h3 id="chapter-2">Chapter 2 Fundamentals: Intro to Testing Principles</h3>

<p>First I capture what to do in the form of a test. Then I follow my own instructions by getting the test to pass. Then I repeat. This is a much lighter cognitive burden than if I were to juggle these different mental jobs and allows me to be productive for longer because I don’t run out of mental energy as early in the day.</p>

<p>The first truth is that it’s impossible to write a piece of code cleanly on the first try. Some amount of refactoring, typically a lot of refactoring, is necessary in order to get the code into a reasonably good state.</p>

<p>The second truth is that it’s impossible to do non-trivial refactorings without having automated tests. The feedback cycle is just too long when all the testing is done manually. Either that or the risk of refactoring without testing afterward is just too large to be justified.</p>

<p>“What level of test coverage should I shoot for?” is one of the questions most commonly asked by beginners to Rails testing.</p>

<p>My answer is that you shouldn’t shoot for a particular level of test coverage. I recommend that instead you make testing a habitual part of your development workflow. A healthy level of test coverage will flow from there.</p>

<p>All software has bugs, but if you feel like the rate of new bugs appearing in production is unacceptably high, it may be a symptom of too little test coverage.</p>

<p>The only alternative to using automated tests, aside from not testing at all, is to test manually.</p>

<p>Infrequent deployments can arise as a symptom of too few tests for a couple different reasons. One possible reason is that the need for manual testing bottlenecks the deployment timing. If it takes two days for manual testers to do a full regression test on the application, you can of course only deploy a fully-tested version of your application once every two days at maximum.</p>

<p>Inability to refactor or make big changes.</p>

<p>Testing != TDD</p>

<p>TDD is a specific kind of testing practice where you write the tests before you write the code that makes the test pass.</p>

<h3 id="chapter-3">Chapter 3 Fundamentals: Rails Testing Tools</h3>

<p>A common Rails testing question is which testing framework to use. RSpec and Minitest are the two options that most people are deciding between.</p>

<p>Most of us don’t have much choice as to whether to use RSpec or Minitest at work.</p>

<p>For better or worse, it’s my experience and the experience of most Rails developers I’ve talked with that most commercial projects use RSpec. (Note how I said most commerical projects. Most commercial projects use RSpec and most OSS Ruby projects, in my experience, use Minitest. I do not know why this is the way it is.)</p>

<p>What does this mean? My take is that this means if your goal is to get a Rails job, learning RSpec over Minitest will give you a higher probability that your skills match the tech stack that’s used at any particular company</p>

<p>RSpec and Minitest differ syntactically but they don’t really have meaningful conceptual differences.</p>

<p>I’ll explain what the major tools are but I want to preface it by saying that the most important thing to learn to be a successful tester is testing principles, not testing tools.</p>

<ul>
  <li>
    <p>RSpec. RSpec is a test framework. A test framework is what gives us a structure for writing our tests as well as the ability to run our tests.</p>
  </li>
  <li>
    <p>Factory Bot. One of the challenges of Rails testing is generating test data. There are two common ways of generating test data in Rails tests: fixtures and factories.</p>

    <ul>
      <li>
        <p>Fixtures typically take the form of one or more YAML files with some hard-coded data. The data is translated into database records one time, before any of the tests are run, and then deleted afterward. (This happens in a separate test database instance of course.)</p>
      </li>
      <li>
        <p>With factories, database data is generated specifically for each test. Instead of loading all the data once at the beginning and deleting it at the end, data is inserted before each test case and then deleted before the next test case starts. (More precisely, the data isn’t deleted, but rather the test is run inside a database transaction and the data is never committed in the first place, but that’s a mechanical detail that’s not important right now.)</p>
      </li>
    </ul>
  </li>
</ul>

<p>I tend to prefer factories because I like having my data generation right inside my test, close to where the test is happening. With fixtures the data setup is too distant from where the test happens.</p>

<ul>
  <li>
    <p>Capybara. Some Rails tests only exercise Ruby code. Other tests actually open up a browser and simulate user clicks and keystrokes. Simulating user input this way requires us to use some sort of tool to manipulate the browser. Capybara is a library that uses Ruby to wrap a driver (usually the Selenium driver), letting us simulate clicks and keystrokes using convenient Ruby methods.</p>
  </li>
  <li>
    <p>VCR and WebMock. One principle of testing is that tests should be deterministic, meaning they run the same way every time no matter what. When an application’s behavior depends on external services (e.g. a third-party API like Stripe) it makes it harder to have deterministic tests. The tests can be made to fail by an internet connection failure or a temporary outage of the external service.</p>

    <ul>
      <li>VCR can let us run our tests against the real external service, but capture all the service’s responses in local files so that subsequent test runs don’t talk to the external service but rather just go off of the saved responses. That way, even if the internet connection fails or the service goes down, the tests still work</li>
    </ul>
  </li>
</ul>

<p>The different kinds of RSpec tests and when to use each:</p>

<p>The eight types of RSpec specs</p>

<p>• Model specs
• System specs
• Request specs
• Helper specs
• View specs
• Routing specs
• Mailer specs
• Job specs</p>

<p>Jason usage:</p>

<p>• Model specs always
• System specs always
• Request specs rarely
• Helper specs rarely
• View specs never
• Routing specs never
• Mailer specs never
• Job specs never</p>

<ul>
  <li>Model spec</li>
</ul>

<p>I use model specs to test my models’ methods. When I do so, I tend to use a test-first approach and write a failing test before I add a new line of code so that I’m sure every bit of code in my model is covered by a test.</p>

<ul>
  <li>System spec</li>
</ul>

<p>System specs are the only type of test that give me confidence my whole application really works.</p>

<p>Even though system specs are indispensable, they’re not without drawbacks. System specs are somewhat “heavy”</p>

<ul>
  <li>Request spec</li>
</ul>

<p>I tend not to use request specs much because in most cases they would be redundant to my system specs. If I have system specs covering all my features, then of course a broken controller would fail one or more of my tests, making tests specifically for my controllers unnecessary.</p>

<p>I also try to keep my controllers sufficiently simple as to not call for tests of their own.</p>

<p>There are just three scenarios in which I do use request specs.</p>

<ol>
  <li>
    <p>If I’m working on a legacy project with fat controllers, sometimes I’ll use request specs to help me harness and refactor all that controller code.</p>
  </li>
  <li>
    <p>If I’m working on an API-only Rails app, then system specs are physically impossible and I drop down to request specs instead.</p>
  </li>
  <li>
    <p>if it’s just too awkward or expensive to use a system spec in a certain case then I’ll use a request spec instead.</p>
  </li>
</ol>

<p>View and routing spec</p>

<p>I find view specs and routing specs to be redundant to system specs. If something is wrong with one of my views or routes, it’s highly likely that one of my system specs will catch the problem.</p>

<p>What are all the Rails testing tools and how do I use them?</p>

<p>RSpec is a test framework. A test framework is what gives us a structure for writing our tests as well as the ability to run our tests.</p>

<p>How do I add tests to an existing Rails project?</p>

<p>If you have little testing experience, I would suggest getting some practice on a fresh Rails app before trying to introduce testing to the existing Rails project you want to add tests to. Adding tests to an existing project is a distinct skill from writing tests for new projects.</p>

<p>If you’re already comfortable with testing</p>

<p>1) develop a shared vision with your team,
  To improve test coverage, a team must first create a shared vision. They need to agree on what “good testing” means for them, choose the tools and approach they’ll use, and define clear goals and steps to reach their desired level of testing.</p>

<p>2) start with what’s easiest, then
  When introducing tests to an untested codebase, don’t start with the most important or complex features, as those are usually hardest to test. Also, requiring tests for every new change can be impractical because new code often depends on untested parts. Instead, begin with the easiest areas—like simple CRUD operations—to build basic testing habits and infrastructure. This creates a foundation (“a beachhead”) to gradually expand test coverage later.</p>

<p>3) expand your test coverage
  After establishing tests for simple features, gradually move on to more complex ones. This step-by-step approach makes it easier to achieve solid test coverage than starting with the hardest or most valuable parts right away. With the foundational principles and tools in place, it’s time to begin writing your first practice tests.</p>

<h3 id="chapter-4">Chapter 4 Fundamentals: Your First Practice Tests</h3>

<p>I’ll describe how to set up a new Rails application for testing in three parts:</p>

<ol>
  <li>An application template that can add all the necessary gems and configuration</li>
  <li>My setup process (commands I run to create a new Rails app)</li>
  <li>A breakdown of the gems I use</li>
</ol>

<p>Template: 
Application template I created that will do two things: 
  1) install a handful of testing-related gems and 
  2) add a config file that will tell RSpec not to generate certain types of files</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem_group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span>
  <span class="n">gem</span> <span class="s1">'capybara'</span>
  <span class="n">gem</span> <span class="s1">'webdrivers'</span>
  <span class="n">gem</span> <span class="s1">'faker'</span>
<span class="k">end</span>

<span class="n">initializer</span> <span class="s1">'generators.rb'</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">CODE</span><span class="sh">
  Rails.application.config.generators do |g|
    g.test_framework :rspec,
    fixtures: false,
    view_specs: false,
    helper_specs: false,
    routing_specs: false,
    request_specs: false,
    controller_specs: false
  end
</span><span class="no">CODE</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">generate</span> <span class="s1">'rspec:install'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can see the code that will be run within your app if you go to the next link <a href="https://raw.githubusercontent.com/jasonswett/testing_application_template/master/application_template.rb" target="_blank">https://raw.githubusercontent.com/jasonswett/testing_application_template/master/application_template.rb</a></p>

<p>Setup process:</p>

<p>When I run <code class="language-plaintext highlighter-rouge">rails new</code>, I always use the <code class="language-plaintext highlighter-rouge">-T</code> flag for “skip test files” because I always use <code class="language-plaintext highlighter-rouge">RSpec</code> instead of the <code class="language-plaintext highlighter-rouge">Minitest</code> that Rails comes with by default. Also, incidentally, I always use <code class="language-plaintext highlighter-rouge">PostgreSQL</code>. This choice of course has little to do with testing but I’m including it for completeness.</p>

<p>I’m also using the <code class="language-plaintext highlighter-rouge">-m</code> flag so I can pass in my application template.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rails</span> <span class="n">new</span> <span class="n">my_project</span> <span class="o">-</span><span class="no">T</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgresql</span> <span class="p">\</span> 
  <span class="o">-</span><span class="n">m</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">raw</span><span class="p">.</span><span class="nf">githubusercontent</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="p">\</span>
  <span class="n">jasonswett</span><span class="o">/</span><span class="n">testing_application_template</span><span class="p">\</span>
  <span class="sr">/master/</span><span class="n">application_template</span><span class="p">.</span><span class="nf">rb</span>
</code></pre></div></div>

<p>The Gems:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">rspec-rails</code>: The rspec-rails gem is the version of the RSpec gem that’s specifically fitted to Rails</li>
  <li><code class="language-plaintext highlighter-rouge">factory_bot_rails</code>: Factory Bot is a tool for generating test data.</li>
  <li><code class="language-plaintext highlighter-rouge">capybara</code>: Capybara is a tool for writing acceptance tests, i.e. tests that interact with the browser and simulate clicks and keystrokes.</li>
  <li><code class="language-plaintext highlighter-rouge">webdrivers</code>: In order for Selenium to work with a browser, Selenium needs drivers.</li>
  <li><code class="language-plaintext highlighter-rouge">faker</code>: By default, Factory Bot (the tool for generating test data) will give us factories that look something like this:</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:customer</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="s2">"MyString"</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="s2">"MyString"</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="s2">"MyString"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When collision on attribute <code class="language-plaintext highlighter-rouge">first_name</code> arise due to uniqueness, we use <code class="language-plaintext highlighter-rouge">Faker</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:customer</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">first_name</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">last_name</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I also often end up adding the <code class="language-plaintext highlighter-rouge">VCR</code> and <code class="language-plaintext highlighter-rouge">WebMock</code> gems when I need to test functionality that makes external network requests.</p>

<p>Next steps</p>

<p>After I initialize my Rails app, <b>I usually create a walking skeleton by deploying my application to a production and staging environment and adding one small feature, for example the ability to sign in.</b></p>

<p>Building the sign-in feature will prompt me to write my first tests. By working in this way I front-load all the difficult and mysterious work of the project’s early life.</p>

<p>A Rails testing “hello world” using RSpec and Capybara</p>

<p>Jason encourages the reader to start a rails app and add a controller and a test to have a quick win.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># step 1:</span>
<span class="n">rails</span> <span class="n">new</span> <span class="n">my_project</span> <span class="o">-</span><span class="no">T</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgresql</span> <span class="o">-</span><span class="n">m</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">raw</span><span class="p">.</span><span class="nf">githubusercontent</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">jasonswett</span><span class="o">/</span><span class="n">testing_application_template</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">application_template</span><span class="p">.</span><span class="nf">rb</span>

<span class="c1"># step 2:</span>
<span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">controller</span> <span class="n">hello_world</span> <span class="n">index</span>

<span class="c1"># step 3: within the view app/views/hello_world/index.html.erb add the following:</span>
<span class="no">Hello</span><span class="p">,</span> <span class="n">world!</span>

<span class="c1"># step 4: boot up rails server and go to the url ` open http://localhost:3000/hello_world/index`</span>
<span class="err">$</span> <span class="n">rails</span> <span class="n">server</span>

<span class="c1"># step 5: create the next file spec/hello_world_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'Hello world'</span><span class="p">,</span> <span class="ss">type: :system</span> <span class="k">do</span>
    <span class="n">describe</span> <span class="s1">'index page'</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'shows the right content'</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">hello_world_index_path</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Hello, world!'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># step 6: run the test !</span>
<span class="n">rspec</span> <span class="n">spec</span><span class="o">/</span><span class="n">hello_world_spec</span><span class="p">.</span><span class="nf">rb</span>
</code></pre></div></div>

<p>Here is a Jason explanation on what we just wrote as a test:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This pulls in the config from spec/rails_helper.rb</span>
<span class="c1"># that's needed in order for the test to run.</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>
<span class="c1"># RSpec.describe, or just describe, is how all RSpec tests start.</span>
<span class="c1"># The 'Hello world' part is an arbitrary string and could have been anything.</span>
<span class="c1"># In this case we have something extra in our describe block, type: :system.</span>
<span class="c1"># The type: :system setting does have a functional purpose. It's what</span>
<span class="c1"># triggers RSpec to bring Capybara into the picture when we run the test.</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'Hello world'</span><span class="p">,</span> <span class="ss">type: :system</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'index page'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'shows the right content'</span> <span class="k">do</span>
    <span class="c1"># This is where Capybara starts to come into the picture. "visit" is a</span>
    <span class="c1"># Capybara method. hello_world_index_path is just a Rails routing</span>
    <span class="c1"># helper method and has nothing to do with RSpec or Capybara.</span>
    <span class="n">visit</span> <span class="n">hello_world_index_path</span>
    <span class="c1"># The following is a mix of RSpec syntax and Capybara syntax. "expect"</span>
    <span class="c1"># and "to" are RSpec, "page" and "have_content" are Capybara. Newcomers</span>
    <span class="c1"># to RSpec and Capybara's English-sentence-like constructions often</span>
    <span class="c1"># have difficulty remembering when two words are separated by a dot or</span>
    <span class="c1"># an underscore or parenthesis, myself included. Don't worry, you'll</span>
    <span class="c1"># get familiar over time.</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Hello, world!'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><b>Before trusting a passing test, you must first see it fail to confirm it’s actually testing what you think it is. A test that passes even when the code is broken is a false positive. By intentionally breaking the feature and ensuring the test fails, you verify that the test correctly distinguishes between working and broken behavior.</b></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># change the text in the view  app/views/hello_world/index.html.erb</span>
<span class="no">Jello</span><span class="p">,</span> <span class="n">world!</span>
</code></pre></div></div>

<p>When we run our test now it should see it fail with an error message like expected to find
text “Hello, world!” in “Jello, world!”.</p>

<h3 id="chapter-14">Chapter 14 Factory Bot: Introduction</h3>

<p>What Factory Bot is</p>

<p>One of the biggest challenges to a new tester is the question of how to generate test data. Most features in a web application will require you to have some certain database records in place first, but it’s not always clear the best way to bring those records into existence. There are multiple ways to accomplish this.</p>

<p><b>For users of RSpec, the de facto standard way to create test data is to use a tool called Factory Bot. Factory Bot is a Ruby library that allows for convenient generation of database data for tests.</b></p>

<p>There are three ways to generate test data in Rails:</p>

<ul>
  <li>Manually</li>
  <li>Factories</li>
  <li>Fixtures</li>
</ul>

<p>Let’s first explore manual creation.</p>

<p>Manual data creation can be convenient enough if you only have a few attributes on a model and no dependencies.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">valid_payment_type</span> <span class="o">=</span> <span class="no">PaymentType</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Visa'</span><span class="p">)</span>
<span class="n">invalid_payment_type</span> <span class="o">=</span> <span class="no">PaymentType</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">''</span><span class="p">)</span>
</code></pre></div></div>

<p>But now let’s say we have the idea of an <code class="language-plaintext highlighter-rouge">Order</code> which is made up of multiple <code class="language-plaintext highlighter-rouge">LineItems</code> and <code class="language-plaintext highlighter-rouge">Payments</code>, each of which has a <code class="language-plaintext highlighter-rouge">PaymentType</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">line_items: </span><span class="p">[</span>
    <span class="no">LineItem</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Electric dog polisher'</span><span class="p">,</span> <span class="ss">price_cents: </span><span class="mi">40000</span><span class="p">)</span>
  <span class="p">],</span>
  <span class="ss">payments: </span><span class="p">[</span>
    <span class="no">Payment</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
      <span class="ss">amount_cents: </span><span class="mi">40000</span><span class="p">,</span>
      <span class="ss">payment_method: </span><span class="no">PaymentMethod</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Visa'</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>That’s annoying. This is where factories come in handy.</p>

<p>Factories</p>

<p><b>The idea with a factory is basically that you have a method/function that generates
new class instances for you.</b></p>

<p>Here’s an example of how the setup for an <code class="language-plaintext highlighter-rouge">Order</code> instance might look if we used a factory, specifically <code class="language-plaintext highlighter-rouge">Factory Bot</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="ss">:order</span><span class="p">,</span> <span class="c1"># 👈 model Order</span>
  <span class="ss">line_items: </span><span class="p">[</span><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:line_item</span><span class="p">,</span> <span class="ss">price_cents: </span><span class="mi">40000</span><span class="p">)],</span> <span class="c1"># 👈 associations with LineItems</span>
  <span class="ss">payments: </span><span class="p">[</span><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:payment</span><span class="p">,</span> <span class="ss">amount_cents: </span><span class="mi">40000</span><span class="p">)]</span><span class="c1"># 👈 associations with Payments</span>
<span class="p">)</span>
</code></pre></div></div>

<p>In this case we’re specifying only the details that are relevant to the test. We don’t care about the line item name or the payment method. As long as we have a payment total that matches the line item total, that’s all where care about.</p>

<p>Fixtures</p>

<p>Typically fixtures are expressed in terms of YAML files.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># orders.yml</span>
<span class="na">payments_equal_line_item_total</span><span class="pi">:</span>
  <span class="c1"># no attributes needed</span>

<span class="c1"># line_items.yml</span>
<span class="na">electric_dog_polisher</span><span class="pi">:</span>
  <span class="na">order</span><span class="pi">:</span> <span class="s">payments_equal_line_item_total</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Electric</span><span class="nv"> </span><span class="s">dog</span><span class="nv"> </span><span class="s">polisher'</span>
  <span class="na">price_cents</span><span class="pi">:</span> <span class="m">40000</span>

<span class="c1"># payment_methods.yml</span>
<span class="na">visa</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Visa'</span>

<span class="c1"># payments.yml</span>
<span class="na">first</span><span class="pi">:</span>
  <span class="na">order</span><span class="pi">:</span> <span class="s">payments_equal_line_item_total</span>
  <span class="na">payment_method</span><span class="pi">:</span> <span class="s">visa</span>
  <span class="na">amount_cents</span><span class="pi">:</span> <span class="m">40000</span>
</code></pre></div></div>

<p>Once the fixture data is established, instantiating an object that uses the data is as simple as referring to the key for that piece of data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:payments_equal_line_item_total</span><span class="p">)</span>
</code></pre></div></div>

<p>Which is best?</p>

<p>Summary</p>

<p>Manual Data Generation</p>
<ul>
  <li>Quickly becomes tedious but useful for small, simple cases</li>
  <li>Benefits: clarity and low overhead</li>
</ul>

<p>Factories vs Fixtures
The author prefers <code class="language-plaintext highlighter-rouge">factories</code> for several reasons:</p>
<ul>
  <li>Test data specification and usage are close together in the code</li>
  <li>With fixtures, the setup is hidden in YAML files, making it tedious to verify what data is being generated</li>
  <li>Fixtures often lead teams to create a large, complicated “world of data” reused across all tests</li>
</ul>

<p>Testing Philosophy</p>
<ul>
  <li>Prefers starting each test with a clean slate</li>
  <li>Generates only the bare minimum data needed per test</li>
  <li>Makes tests easier to understand</li>
</ul>

<p>Practical Recommendation</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Factories are the go-to method</code> and general recommendation</li>
  <li>Acknowledges the fixture issues are usage problems, not inherent flaws</li>
  <li>Open to using fixtures for specific use cases (e.g., fixed baseline data like payment types)</li>
  <li>Both approaches could be combined in a project when appropriate</li>
</ul>

<p>The key takeaway: <code class="language-plaintext highlighter-rouge">factories</code> are preferred for their transparency and encouraging minimal, test-specific data generation, but the author remains pragmatic about using the right tool for the situation.</p>

<h3 id="chapter-15">Chapter 15 Factory Bot: Getting started</h3>

<p>To install <code class="language-plaintext highlighter-rouge">Factory Bot</code>, add the factory_bot_rails gem to the <code class="language-plaintext highlighter-rouge">:development</code>, <code class="language-plaintext highlighter-rouge">:test</code> group of your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Factory definitions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</code></pre></div></div>
<p>Notice how we don’t have to specify anything at all about the record’s attributes. We only had to pass in :user as an argument. Factory Bot will automatically take care of the details for the user record based on the instructions we specify in the user factory.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="s1">'John'</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="s1">'Smith'</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="s1">'john.smith@example.com'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you may have guessed, <code class="language-plaintext highlighter-rouge">:user</code> maps to our <code class="language-plaintext highlighter-rouge">User</code> model (assuming we have one) and <code class="language-plaintext highlighter-rouge">first_name</code>, <code class="language-plaintext highlighter-rouge">last_name</code> and <code class="language-plaintext highlighter-rouge">email</code> all map to attributes in the <code class="language-plaintext highlighter-rouge">User</code> model.</p>

<p>Below is a more detailed explanation of what each part of the factory definition does.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># FactoryBot is the name of a class.</span>
<span class="c1"># "define" is a class method on the FactoryBot class.</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="c1"># "factory" is a method. It takes, as an argument, the name of the factory</span>
  <span class="c1"># we're defining. By convention, the argument we pass gets matched up with</span>
  <span class="c1"># an ActiveRecord class, e.g. :user gets matched up with User.</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="c1"># Each attribute in our ActiveRecord model can have a corresponding line</span>
    <span class="c1"># in our factory definition. In this case, first_name, last_name and</span>
    <span class="c1"># email are all dynamically-defined methods. Each of these methods</span>
    <span class="c1"># takes a block which supplies the value of the attribute.</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="s1">'John'</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="s1">'Smith'</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="s1">'john.smith@example.com'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Where to put factory definitions</p>

<p>I put all my <code class="language-plaintext highlighter-rouge">factory definitions</code> in <code class="language-plaintext highlighter-rouge">spec/factories</code> and I generally use a convention of putting just one <code class="language-plaintext highlighter-rouge">factory</code> in each file. For example, if I were to have a <code class="language-plaintext highlighter-rouge">factory</code> for a <code class="language-plaintext highlighter-rouge">Product</code> model, I would put it in <code class="language-plaintext highlighter-rouge">spec/factories/products.rb</code>.</p>

<p>There’s unfortunately a problem with our configuration: if we do <code class="language-plaintext highlighter-rouge">FactoryBot.create(:user)</code> again, we’ll just get an exact duplicate with all the same attribute values, which is of course often not desirable.</p>

<p>We’ll address this issue later on though.</p>

<h3 id="chapter-16">Chapter 16. Factory Bot: Build Strategies and Faker</h3>

<p>For creating objects using <code class="language-plaintext highlighter-rouge">Factory Bot</code>, there are two main methods offered: <code class="language-plaintext highlighter-rouge">create</code> and <code class="language-plaintext highlighter-rouge">build</code>. Let’s take a look at each, continuing to use our <code class="language-plaintext highlighter-rouge">User</code> factory as an example.</p>

<ul>
  <li>
    <p>If we were to run <code class="language-plaintext highlighter-rouge">FactoryBot.create(:user)</code>, it would return a persisted instance of a
<code class="language-plaintext highlighter-rouge">User</code> model.</p>
  </li>
  <li>
    <p>If we were to run <code class="language-plaintext highlighter-rouge">FactoryBot.build(:user)</code>, it would return an unpersisted
instance of a <code class="language-plaintext highlighter-rouge">User</code> model.</p>
  </li>
</ul>

<p><b>Whenever possible, we’re going to favor <code class="language-plaintext highlighter-rouge">.build</code> over <code class="language-plaintext highlighter-rouge">.create</code>, as persisting to the database is one of the slowest operations in our tests.</b></p>

<p>If we go to the terminal and instantiate the next model with different methods:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># we try out `.create`</span>
<span class="o">=&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">persisted?</span> <span class="c1"># true</span>
<span class="o">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span> <span class="c1"># an ID value 45700</span>

<span class="c1"># then we try out `.build`</span>
<span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">persisted?</span> <span class="c1"># false</span>
<span class="o">&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">id</span> <span class="c1"># nil</span>
</code></pre></div></div>

<p>Using Factory Bot with Faker</p>

<p>There’s a problem with using hard-coded values in <code class="language-plaintext highlighter-rouge">factory definitions</code>. What if our <code class="language-plaintext highlighter-rouge">users</code> table had a unique constraint on the <code class="language-plaintext highlighter-rouge">email</code> column? In that case, the first usage of <code class="language-plaintext highlighter-rouge">FactoryBot.create(:user)</code> would work fine, but the second time we did it, the database wouldn’t allow the duplicate record to be created, and we’d have a problem.</p>

<p>Here’s an example of how that would go using <code class="language-plaintext highlighter-rouge">Faker</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="s1">'John'</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="s1">'Smith'</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Faker::Internet.email</code> will return values like <code class="language-plaintext highlighter-rouge">kris@hoeger.io</code> or <code class="language-plaintext highlighter-rouge">marionstroman@hamill.io</code>. I find these sorts of values nicer to work with than a hard-coded value with a number or hash slapped on the end of it.</p>

<p>Entire <code class="language-plaintext highlighter-rouge">Factory</code> for <code class="language-plaintext highlighter-rouge">User</code> model using <code class="language-plaintext highlighter-rouge">Faker</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">first_name</span> <span class="p">}</span>
    <span class="n">last_name</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">last_name</span> <span class="p">}</span>
    <span class="n">email</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="chapter-17">Chapter 17 Factory Bot: Advanced Usage</h3>

<p>Nested factories</p>

<p>Sometimes you want to be able to create records that are 95% the same as the “default” but
have one or two small differences.</p>

<ul>
  <li>Physician user example</li>
</ul>

<p>The Problem:</p>
<ul>
  <li>30 tests need regular users</li>
  <li>6 tests need physician users (users with <code class="language-plaintext highlighter-rouge">role</code> set to <code class="language-plaintext highlighter-rouge">'physician'</code>)</li>
  <li>How do you handle this variation without problems?</li>
</ul>

<p>Three Options Evaluated</p>

<ol>
  <li>Set role individually in each test ❌
    <ul>
      <li>Bad: Code duplication</li>
      <li>If physician user requirements change, you’d need to update all 6 places</li>
      <li>Maintenance nightmare</li>
    </ul>
  </li>
  <li>Make all users physician users by default ❌
    <ul>
      <li>Bad: Misleading and violates best practices</li>
      <li>Creates unnecessary setup data for 30 tests that don’t need it</li>
      <li>Test maintainers can’t tell which setup data is actually necessary</li>
      <li>Principle: Create the minimum amount of setup data and no more</li>
    </ul>
  </li>
  <li>Create a nested factory that inherits from the base user factory ✅
    <ul>
      <li>This is the right answer</li>
      <li>No duplication</li>
      <li>Doesn’t modify the default factory</li>
      <li>Clear and maintainable</li>
      <li>In Factory Bot, this is called “nested factories”</li>
    </ul>
  </li>
</ol>

<p>Key Testing Principle
Tests should only include the minimum necessary setup data. Extraneous data misleads future maintainers who can’t distinguish between essential and superfluous setup.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Normal Factory for User model</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Nested factory</span>

<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>

    <span class="n">factory</span> <span class="ss">:physician_user</span> <span class="k">do</span>
      <span class="n">role</span> <span class="p">{</span> <span class="s1">'physician'</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage of that nested Factory</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:physician_user</span><span class="p">)</span>
</code></pre></div></div>

<p>Traits</p>

<p><b>Traits solve a similar problem to the one nested factories solve, but in a different way. With nested factories, you’re defining a child factory inside an existing factory, with the child factory inheriting from the parent factory.</b></p>

<p>With traits, you’re defining additional qualities that can optionally be added to an existing
object.&lt;/b&gt;</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Normal Factory for User model</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Traits</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>

    <span class="n">trait</span> <span class="ss">:with_name</span> <span class="k">do</span>
      <span class="n">first_name</span> <span class="p">{</span> <span class="s2">"John"</span> <span class="p">}</span>
      <span class="n">last_name</span> <span class="p">{</span> <span class="s2">"Smith"</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">trait</span> <span class="ss">:with_phone_number</span> <span class="k">do</span>
      <span class="n">phone_number</span> <span class="p">{</span> <span class="s2">"(555) 555-5555"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage of that Traits</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">traits: </span><span class="p">[</span><span class="ss">:with_name</span><span class="p">,</span> <span class="ss">:with_phone_number</span><span class="p">])</span><span class="o">.</span>
</code></pre></div></div>

<p>When to use <code class="language-plaintext highlighter-rouge">traits</code> versus nested <code class="language-plaintext highlighter-rouge">factories</code></p>

<p>My method is pretty simple: If the <code class="language-plaintext highlighter-rouge">factory</code> I’m considering has something, I use a <code class="language-plaintext highlighter-rouge">trait</code>. If the <code class="language-plaintext highlighter-rouge">factory</code> is something, I use a <code class="language-plaintext highlighter-rouge">nested</code> factory. Let’s look at a concrete example.</p>

<p>“Has” example (trait)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The user is still conceptually a regular old `user`. The only difference is that this user happens to have a value for its `phone_number` attribute.</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>

    <span class="n">trait</span> <span class="ss">:with_phone_number</span> <span class="k">do</span>
      <span class="n">phone_number</span> <span class="p">{</span> <span class="s2">"(555) 555-5555"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage of that Traits</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:with_phone_number</span><span class="p">)</span>
</code></pre></div></div>

<p>“Is” example (nested factory)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A `physician` user has different capabilities from a regular `user` and is used in different ways from a regular `user`.</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>

    <span class="n">factory</span> <span class="ss">:physician_user</span> <span class="k">do</span>
      <span class="n">role</span> <span class="p">{</span> <span class="s1">'physician'</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage of that nested Factory</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:physician_user</span><span class="p">)</span>
</code></pre></div></div>

<p>Callbacks</p>

<p>Imagine you need to create a <code class="language-plaintext highlighter-rouge">User</code> record that has a <code class="language-plaintext highlighter-rouge">Message</code> associated with it. This is an option:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="n">create</span><span class="p">(</span><span class="ss">:message</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">)</span>
</code></pre></div></div>

<p>But if you need to create such <code class="language-plaintext highlighter-rouge">users</code> over and over, your code could get repetitive. You can create a more convenient way to meet your needs by using <b>callbacks</b>.</p>

<p>Below is a concrete example. We have a <code class="language-plaintext highlighter-rouge">:user</code> factory and then, inside that, a nested
factory called <code class="language-plaintext highlighter-rouge">:user_with_message</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">username</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">username</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">password</span> <span class="p">}</span>

    <span class="n">factory</span> <span class="ss">:user_with_message</span> <span class="k">do</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">create</span><span class="p">(</span><span class="ss">:message</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When <code class="language-plaintext highlighter-rouge">FactoryBot.create(:user_with_message)</code> is run, everything happens that would happen when <code class="language-plaintext highlighter-rouge">FactoryBot.create(:user)</code> is run, plus the stuff in the <code class="language-plaintext highlighter-rouge">after(:create)</code> callback is executed.</p>

<p>The various callback types:</p>

<p>• <code class="language-plaintext highlighter-rouge">after(:create)</code> - called after a factory is saved (via FactoryBot.create)
• <code class="language-plaintext highlighter-rouge">after(:build)</code> - called after a factory is built (via FactoryBot.build or FactoryBot.create)
• <code class="language-plaintext highlighter-rouge">before(:create)</code> - called before a factory is saved (via FactoryBot.create)
• <code class="language-plaintext highlighter-rouge">after(:create)</code> - called after a factory is saved (via FactoryBot.create)
• <code class="language-plaintext highlighter-rouge">after(:stub)</code> - called after a factory is stubbed (via FactoryBot.build_stubbed)</p>

<p>Transient attributes</p>

<p>Transient attributes are values that are passed into the <code class="language-plaintext highlighter-rouge">factory</code> but not directly set on the object’s attributes.</p>

<p>PDF file attachment example</p>

<p>Let’s say we have an <code class="language-plaintext highlighter-rouge">InsuranceDeposit</code> class that has PDF file attachments.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">InsuranceDeposit</span>
  <span class="n">has_many_attached</span> <span class="ss">:pdf_files</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An example without using <code class="language-plaintext highlighter-rouge">transient</code> attributes</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">insurance_deposit</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:insurance_deposit</span><span class="p">)</span>
<span class="c1"># This setup is noisy and hard to understand</span>
<span class="n">file</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pdf</span><span class="p">.</span><span class="nf">text</span> <span class="s2">"my arbitrary PDF content"</span>
<span class="n">pdf</span><span class="p">.</span><span class="nf">render_file</span> <span class="n">file</span><span class="p">.</span><span class="nf">path</span>

<span class="n">insurance_deposit</span><span class="p">.</span><span class="nf">pdf_files</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span>
  <span class="ss">io: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">path</span><span class="p">),</span>
  <span class="ss">filename: </span><span class="s2">"file.pdf"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>This way is non-ideal because a) the code is hard to understand and b) if we use these steps end more than one place, we’ll have duplication</p>

<p>An example with transient attributes</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:insurance_deposit</span> <span class="k">do</span>
    <span class="n">transient</span> <span class="k">do</span>
      <span class="n">pdf_content</span> <span class="p">{</span> <span class="s2">""</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">insurance_deposit</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">|</span>
      <span class="n">file</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">pdf</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">pdf</span><span class="p">.</span><span class="nf">text</span> <span class="n">evaluator</span><span class="p">.</span><span class="nf">pdf_content</span>
      <span class="n">pdf</span><span class="p">.</span><span class="nf">render_file</span> <span class="n">file</span><span class="p">.</span><span class="nf">path</span>

      <span class="n">insurance_deposit</span><span class="p">.</span><span class="nf">pdf_files</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span>
        <span class="ss">io: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">path</span><span class="p">),</span>
        <span class="ss">filename: </span><span class="s2">"file.pdf"</span>
        <span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># usage of transient</span>
<span class="n">create</span><span class="p">(</span><span class="ss">:insurance_deposit</span><span class="p">,</span> <span class="ss">pdf_content: </span><span class="s2">"my arbitrary PDF content"</span><span class="p">)</span>
</code></pre></div></div>

<p>This is much tidier than the original. If we want to see how <code class="language-plaintext highlighter-rouge">pdf_content</code> works, we can open up the <code class="language-plaintext highlighter-rouge">insurance_deposit</code> factory and have a look.</p>

<h3 id="chapter-18">Chapter 18. RSpec Syntax: Introduction</h3>

<p>RSpec Syntax: Introduction</p>

<p>In this section we’ll address both the RSpec DSL and the underlying Ruby concepts that are helpful to understand in order to understand RSpec’s DSL.</p>

<p>Here’s what we’re going to cover in this section:</p>

<ol>
  <li>The Structure of a Test</li>
  <li>Understanding Blocks</li>
  <li>Let, Let! and Instance Variables</li>
  <li>The Parts of an RSpec Test</li>
  <li>Build Your Own RSpec, Part 1</li>
  <li>Build Your Own RSpec, Part 2</li>
  <li>Describe and Context</li>
</ol>

<h3 id="chapter-19">Chapter 19. RSpec Syntax: The Structure of a Test</h3>

<p>No matter what test framework is being used, a test tends to contain four basic parts, or phases:</p>

<ol>
  <li>Setup</li>
  <li>Exercise</li>
  <li>Assertion</li>
  <li>Teardown</li>
</ol>

<p>We can illustrate these four phases using an example. Let’s say we have an application that has a list of users that can receive messages. Only active users are allowed to receive messages. So, we need to assert that when a user is inactive, that user can’t receive messages.</p>

<p>Here’s how this test might go:</p>

<ol>
  <li>Create a <code class="language-plaintext highlighter-rouge">User</code> record (setup)</li>
  <li>Set the user’s “active” status to <code class="language-plaintext highlighter-rouge">false</code> (exercise)</li>
  <li>Assert that the user is not “<code class="language-plaintext highlighter-rouge">messageable</code>” (assertion)</li>
  <li>Delete the <code class="language-plaintext highlighter-rouge">User</code> record we created in step 1 (teardown)</li>
</ol>

<p>The purpose of each test phase</p>

<ul>
  <li>Setup</li>
</ul>

<p>The setup phase typically creates all the data that’s needed in order for the test to operate. (There are other things that could conceivably happen during a setup phase but for our current purposes we can think of the setup phase’s role as being to put data in place).</p>

<p>In our case, the creation of the <code class="language-plaintext highlighter-rouge">User</code> record is all that’s involved in the setup step, although more complicated tests could of course create any number of database records and potentially establish relationships among them.</p>

<ul>
  <li>Exercise</li>
</ul>

<p>The exercise phase walks through the motions of the feature we want to test. With our messaging example, the exercise phase is when the user gets put in an inactive state.</p>

<p>Side note: the distinction between setup and exercise may seem blurry, and indeed it sometimes is, especially in low-level tests like our current example. If someone were to argue that setting the user to inactive should actually be part of the setup, I’m not sure how I’d refute them.</p>

<ul>
  <li>Assertion</li>
</ul>

<p>The assertion phase is basically what all the other phases exist in support of. <b>The assertion is the actual test part of the test, the thing that determines whether the test passes or fails.</b></p>

<ul>
  <li>Teardown</li>
</ul>

<p>Each test needs to clean up after itself. If it didn’t, then each test would potentially pollute the world in which the test is running and affect the outcome of later tests, making the tests non-deterministic. We don’t want this. We want deterministic tests, i.e. tests that behave the same exact way every single time no matter what. The only thing that should make a test go from passing to failing or vice-versa is if the behavior that the test tests changes.</p>

<p>In reality, Rails tests tend not to have an explicit teardown step. The main pollutant we have to worry about with our tests is database data that gets left behind. <b>RSpec is capable of taking care of this problem for us by running each test in a database transaction. The transaction starts before each test is run and aborts after the test finishes. So really, the data never gets permanently persisted in the first place.</b></p>

<p>A concrete example</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test@example.com'</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># setup</span>

    <span class="n">describe</span> <span class="s1">'#messageable?'</span> <span class="k">do</span>
      <span class="n">context</span> <span class="s1">'is inactive'</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s1">'is false'</span> <span class="k">do</span>
          <span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">active: </span><span class="kp">false</span><span class="p">)</span>           <span class="c1"># exercise</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">messageable?</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span> <span class="kp">false</span> <span class="c1"># assertion</span>
          <span class="n">user</span><span class="p">.</span><span class="nf">destroy!</span>                         <span class="c1"># teardown</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="chapter-20-rspec-syntax-let-let-and-instance-variables-chapter-20">Chapter 20. RSpec Syntax: Let, Let! and Instance Variables {chapter-20}</h3>

<p>The purpose of <code class="language-plaintext highlighter-rouge">let</code> and the differences between <code class="language-plaintext highlighter-rouge">let</code> and <code class="language-plaintext highlighter-rouge">instance variables</code></p>

<p>RSpec’s <code class="language-plaintext highlighter-rouge">let</code> helper method is a way of defining values that are used in tests. Below is a typical example.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>
  <span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'does not have an id when first instantiated'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># here we use a before hook https://rspec.info/features/3-12/rspec-core/hooks/before-and-after-hooks/</span>

<span class="nb">require</span> <span class="s1">'rspec'</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s1">'does not have an id when first instantiated'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Differences between let and instance variables</p>

<p>Summary</p>

<p>Stylistic Differences</p>
<ul>
  <li>Syntax varies: instance variables use <code class="language-plaintext highlighter-rouge">@</code> prefix</li>
  <li>Author personally finds <code class="language-plaintext highlighter-rouge">let</code> syntax slightly tidier</li>
</ul>

<p>Mechanical Differences</p>

<ol>
  <li>Error Detection
    <ul>
      <li>Instance variables: Ruby doesn’t complain if you use an undefined one—it just returns <code class="language-plaintext highlighter-rouge">nil</code>
        <ul>
          <li>Danger: You might accidentally pass <code class="language-plaintext highlighter-rouge">nil</code> to a method and test the wrong behavior</li>
          <li>Risk is relatively low</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">let</code> helper: Defines a memoized method, not an instance variable
        <ul>
          <li>If you typo the method name, Ruby will raise an error (good!)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Lazy Evaluation
    <ul>
      <li><code class="language-plaintext highlighter-rouge">let</code> can create values that are evaluated lazily</li>
      <li>Author considers this dangerous and a bad idea (more explanation promised later)</li>
    </ul>
  </li>
</ol>

<p>Most Important Difference: Test Isolation</p>

<ul>
  <li>Instance variables in <code class="language-plaintext highlighter-rouge">before</code> blocks can leak between test files
    <ul>
      <li>Example: <code class="language-plaintext highlighter-rouge">@customer</code> set in “File A” can be referenced in “File B”</li>
      <li>This is bad: Tests should be completely deterministic and independent</li>
    </ul>
  </li>
  <li>Implication: <code class="language-plaintext highlighter-rouge">let</code> is safer for maintaining test isolation</li>
</ul>

<p>Bottom Line: <code class="language-plaintext highlighter-rouge">let</code> provides better error detection and test isolation compared to instance variables.</p>

<p>How <code class="language-plaintext highlighter-rouge">let</code> works</p>

<p><code class="language-plaintext highlighter-rouge">let</code> is NOT a variable, it’s a method that returns a memoized method (a method that only runs once).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_name</span>
  <span class="nb">puts</span> <span class="s1">'thinking about what my name is...'</span>
  <span class="s1">'Jason Swett'</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">my_name</span>


<span class="c1"># output:</span>
<span class="n">thinking</span> <span class="n">about</span> <span class="n">what</span> <span class="n">my</span> <span class="nb">name</span> <span class="n">is</span><span class="o">...</span>
<span class="no">Jason</span> <span class="no">Swett</span>
</code></pre></div></div>

<p>Same thing using <code class="language-plaintext highlighter-rouge">let</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'my_name'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:my_name</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'thinking about what my name is...'</span>
    <span class="s1">'Jason Swett'</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'returns my name'</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="n">my_name</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1"># output:</span>
<span class="n">thinking</span> <span class="n">about</span> <span class="n">what</span> <span class="n">my</span> <span class="nb">name</span> <span class="n">is</span><span class="o">...</span>
<span class="no">Jason</span> <span class="no">Swett</span>
</code></pre></div></div>

<p>Memoization in action</p>

<p>The method body only executes once, but returns the value twice.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'my_name'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:my_name</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'thinking about what my name is...'</span>
    <span class="s1">'Jason Swett'</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'returns my name'</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="n">my_name</span>
    <span class="nb">puts</span> <span class="n">my_name</span>  <span class="c1"># Called twice</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># output:</span>
<span class="n">thinking</span> <span class="n">about</span> <span class="n">what</span> <span class="n">my</span> <span class="nb">name</span> <span class="n">is</span><span class="o">...</span>  <span class="c1"># Only prints once!</span>
<span class="no">Jason</span> <span class="no">Swett</span>
<span class="no">Jason</span> <span class="no">Swett</span>
</code></pre></div></div>

<p>Lazy Evaluation <code class="language-plaintext highlighter-rouge">let</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'let'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:message</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'let block is running'</span>
    <span class="s1">'VALUE'</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'does stuff'</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'start of example'</span>
    <span class="nb">puts</span> <span class="n">message</span>
    <span class="nb">puts</span> <span class="s1">'end of example'</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1"># output:</span>
<span class="n">start</span> <span class="n">of</span> <span class="n">example</span>
<span class="n">let</span> <span class="n">block</span> <span class="n">is</span> <span class="n">running</span>  <span class="c1"># Runs only when message is called</span>
<span class="no">VALUE</span>
<span class="k">end</span> <span class="n">of</span> <span class="n">example</span>
</code></pre></div></div>

<p>Immediate Evaluation <code class="language-plaintext highlighter-rouge">let!</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="n">describe</span> <span class="s1">'let!'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:message</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'let block is running'</span>
    <span class="s1">'VALUE'</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'does stuff'</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'start of example'</span>
    <span class="nb">puts</span> <span class="n">message</span>
    <span class="nb">puts</span> <span class="s1">'end of example'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># output:</span>
<span class="n">let</span> <span class="n">block</span> <span class="n">is</span> <span class="n">running</span>  <span class="c1"># Runs BEFORE test starts</span>
<span class="n">start</span> <span class="n">of</span> <span class="n">example</span>
<span class="no">VALUE</span>
<span class="k">end</span> <span class="n">of</span> <span class="n">example</span>
</code></pre></div></div>

<p>Author’s Recommendation
Always use <code class="language-plaintext highlighter-rouge">let!</code> instead of <code class="language-plaintext highlighter-rouge">let</code>
Why?</p>
<ul>
  <li>Lazy evaluation (<code class="language-plaintext highlighter-rouge">let</code>) can be subtly confusing
    <ul>
      <li>Example: A database record might be saved at an unclear point in execution</li>
    </ul>
  </li>
  <li>No real-world benefit to lazy evaluation</li>
  <li>Performance gains are negligible</li>
  <li>Confusion is more expensive than slowness</li>
</ul>

<p>Practical takeaways:</p>

<p>• The biggest advantage to using <code class="language-plaintext highlighter-rouge">let</code> over <code class="language-plaintext highlighter-rouge">instance variables</code> is that <code class="language-plaintext highlighter-rouge">instance variables</code> can leak from test to test, which isn’t true of <code class="language-plaintext highlighter-rouge">let</code>.
• The difference between <code class="language-plaintext highlighter-rouge">let</code> and <code class="language-plaintext highlighter-rouge">let!</code> is that the former is lazily evaluated while the latter is immediately evaluated.
• I always use the <code class="language-plaintext highlighter-rouge">let!</code> version because I find the execution path to be more easily understandable.</p>

<h3 id="chapter-21">Chapter 21. RSpec Syntax: The Parts of an RSpec Test</h3>

<p>In this chapter we’re going to write a small test and thoroughly examine it. We’ll look at the parts of the test bit-by-bit so we can understand each piece as well as the whole. By the end of this chapter, the syntax of an <code class="language-plaintext highlighter-rouge">RSpec</code> file will look much less mysterious.</p>

<p>We’re going to write a small, trivial method and then write an <code class="language-plaintext highlighter-rouge">RSpec</code> test for the method. Our method, called <code class="language-plaintext highlighter-rouge">emphasize</code>, will convert a string to uppercase and add an exclamation point at the end. For example, the <code class="language-plaintext highlighter-rouge">emphasize</code> method would convert awesome to <code class="language-plaintext highlighter-rouge">AWESOME!</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here is the test for that method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’re going to examine each part of this test, but first let’s talk about some terminology.</p>

<p>Specs, examples, “example groups” and “it blocks”</p>

<p>Tests vs. specs</p>

<p>In <code class="language-plaintext highlighter-rouge">RSpec</code>, the contents of an <code class="language-plaintext highlighter-rouge">RSpec</code> file are referred to as a <code class="language-plaintext highlighter-rouge">spec</code>, short for specification. <code class="language-plaintext highlighter-rouge">Spec</code> files in <code class="language-plaintext highlighter-rouge">RSpec</code> are suffixed with <code class="language-plaintext highlighter-rouge">_spec</code>. These files must be suffixed so in order for the <code class="language-plaintext highlighter-rouge">RSpec</code> runner to recognize them as spec files. An example spec filename would be <code class="language-plaintext highlighter-rouge">patient_spec.rb</code>. Each spec usually contains a number of example groups.</p>

<p>Example groups are a way of putting related tests into groups. The example group is the outermost block which starts with <code class="language-plaintext highlighter-rouge">RSpec.describe</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span> <span class="c1"># ⬅ this is the example group </span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># they can be nested too</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span> <span class="c1"># ⬅ this is the example group for valid input</span>
  <span class="n">describe</span> <span class="s2">"valid input"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"invalid input"</span> <span class="k">do</span> <span class="c1"># ⬅ this is the example group for invalid input</span>
    <span class="n">it</span> <span class="s1">'returns nil when input is not String'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="mi">7</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Examples and “it blocks”</p>

<p>Each individual test in <code class="language-plaintext highlighter-rouge">RSpec</code> is known as an example. A single <code class="language-plaintext highlighter-rouge">spec</code> (which, remember, means a single <code class="language-plaintext highlighter-rouge">RSpec</code> file) may contain any number of examples:</p>

<p>Why <code class="language-plaintext highlighter-rouge">it</code> blocks? My interpretation is that the <code class="language-plaintext highlighter-rouge">it</code> blocks help make each example read like an English sentence. In the example above the English sentence would of course be “it makes the text uppercase and adds an exclamation point”</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span> <span class="c1"># ⬅ this is the it block or example or test case</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">expect</code> keyword</p>

<p>The <code class="language-plaintext highlighter-rouge">expect</code> is the part of the test (or, more precisely, the part of the <code class="language-plaintext highlighter-rouge">example</code>) where the test itself actually happens. In the snippet below we’re expecting that the return value of <code class="language-plaintext highlighter-rouge">emphasize('hello')</code> is equal to <code class="language-plaintext highlighter-rouge">'HELLO!'</code>. If this expectation is met when we run the spec, then this example will pass. Otherwise the <code class="language-plaintext highlighter-rouge">example</code> will fail and the <code class="language-plaintext highlighter-rouge">RSpec</code> test runner will let us know exactly how the example failed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span> 
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span> <span class="c1"># ⬅ this is the expect keyword for this test case</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">eq</code> matcher</p>

<p>The syntax of <code class="language-plaintext highlighter-rouge">.to eq()</code> often looks strange and arbitrary to <code class="language-plaintext highlighter-rouge">RSpec</code> beginners. Much of the <code class="language-plaintext highlighter-rouge">RSpec</code> syntax (which we’ll see a lot more of soon) can look like a soup of dots, spaces and underscores, with no apparent rhyme or reason as to what’s what. Luckily, I assure you that this confusion goes away as you get more familiar with what the <code class="language-plaintext highlighter-rouge">RSpec DSL</code> is made of and as you get practice writing <code class="language-plaintext highlighter-rouge">RSpec tests</code>.</p>

<p>For the <code class="language-plaintext highlighter-rouge">.to</code> part of <code class="language-plaintext highlighter-rouge">expect(emphasize('hello')).to eq('HELLO!')</code>, it helps to recognize that to is just a method. In fact, we can add the missing optional parentheses on the to method to make it clearer that to is just a method.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">eq</code> is also a method. The argument that we pass to the to method is <code class="language-plaintext highlighter-rouge">eq('HELLO!')</code>, so in
other words, whatever the return value of <code class="language-plaintext highlighter-rouge">eq('HELLO')</code> is is what gets passed to <code class="language-plaintext highlighter-rouge">to</code>. What’s
the return value of <code class="language-plaintext highlighter-rouge">eq('HELLO')</code>?</p>

<h3 id="chapter-22">Chapter 22. RSpec Syntax: Build Your Own RSpec, Part 1</h3>

<p>What we’re going to do:</p>

<p>In this chapter we’re going to build our own<code class="language-plaintext highlighter-rouge"> RSpec-like</code> test framework called <code class="language-plaintext highlighter-rouge">MySpec</code>. By the end of this chapter you’ll be able to run the following test file</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Our desired test file</span>
<span class="nb">require_relative</span> <span class="s1">'./my_spec'</span>

<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="c1"># Above this line is the "application code"</span>
<span class="c1"># and below this line is the test code</span>
<span class="c1"># -----------------------------------------</span>

<span class="no">MySpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Step 1: <code class="language-plaintext highlighter-rouge">expect</code></p>

<p>For convenience, we’ll include the “<code class="language-plaintext highlighter-rouge">application code</code>” (i.e. the <code class="language-plaintext highlighter-rouge">emphasize</code> method) right in the same file as the test code.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># emphasize_spec.rb</span>
<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Throughout this process, we’re going to use the method of “error-driven development” (not a real thing, just something I made up). We’ll write some code, run the code, see what errors we get, fix the errors, and repeat.</p>

<p>if we run the file <code class="language-plaintext highlighter-rouge">$ ruby emphasize_spec.rb</code> we get the next error:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emphasize_spec</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">5</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;': undefined method `</span><span class="n">expect</span><span class="err">'</span> <span class="k">for</span> <span class="n">main</span><span class="ss">:Object</span> <span class="p">(</span><span class="no">NoMethodError</span><span class="p">)</span>
</code></pre></div></div>

<p>The error is telling us expect is an <code class="language-plaintext highlighter-rouge">undefined method</code>, which is true. We haven’t defined a method called <code class="language-plaintext highlighter-rouge">expect</code> yet. Let’s define it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">things</span><span class="p">)</span> <span class="c1"># we added the method expect with an argument</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, if we run the file we get a different error:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emphasize_spec</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">8</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;': undefined method `</span><span class="n">eq</span><span class="err">'</span> <span class="k">for</span> <span class="n">main</span><span class="ss">:Object</span> <span class="p">(</span><span class="no">NoMethodError</span><span class="p">)</span><span class="sb">`
</span></code></pre></div></div>

<p>It’s time to add <code class="language-plaintext highlighter-rouge">eq</code> to the file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="c1"># we added the method eq with an argument</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Now that we have defined both <code class="language-plaintext highlighter-rouge">expect</code> and <code class="language-plaintext highlighter-rouge">eq</code> we get another error:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emphasize_spec</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">11</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;': undefined method `</span><span class="n">to</span><span class="err">'</span> <span class="k">for</span> <span class="kp">nil</span><span class="ss">:NilClass</span> <span class="p">(</span><span class="no">NoMethodError</span><span class="p">)</span>
</code></pre></div></div>

<p>This one is perhaps less straightforward, so I’ll explain what’s happening. This error means that the object we’re calling <code class="language-plaintext highlighter-rouge">to</code> on is <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<p>We’re calling to on <code class="language-plaintext highlighter-rouge">expect(emphasize('hello'))</code>, so it must be that the return value of <code class="language-plaintext highlighter-rouge">expect(emphasize('hello'))</code> is <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<p>This is indeed the case. When we defined <code class="language-plaintext highlighter-rouge">expect</code>, we didn’t put a body in the method definition, so the return value of expect is <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<p>To fix this error, we need to change <code class="language-plaintext highlighter-rouge">expect</code> from returning <code class="language-plaintext highlighter-rouge">nil</code> to returning an <code class="language-plaintext highlighter-rouge">object</code> that will respond to a method called <code class="language-plaintext highlighter-rouge">to</code>. The only mystery is exactly what we should return.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">things</span><span class="p">)</span>
  <span class="no">ExpectationTarget</span><span class="p">.</span><span class="nf">new</span> <span class="c1"># we added this new class so that we don't call .to on nil object</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, the error is:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emphasize_spec</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">15</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;': undefined method `</span><span class="n">to</span><span class="err">'</span>
<span class="k">for</span> <span class="c1">#&lt;ExpectationTarget:0x00007fe3020271b8&gt; (NoMethodError)</span>
</code></pre></div></div>

<p>And that’s because we have not even defined the <code class="language-plaintext highlighter-rouge">ExpectationTarget</code> class</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ExpectationTarget</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="vi">@output</span> <span class="o">=</span> <span class="n">output</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@output</span> <span class="o">==</span> <span class="n">expected_output</span>
      <span class="nb">puts</span> <span class="s1">'.'</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Expected </span><span class="si">#{</span><span class="vi">@output</span><span class="si">}</span><span class="s2"> to equal </span><span class="si">#{</span><span class="n">expected_output</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="no">ExpectationTarget</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
  <span class="n">expected_output</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>If we run the file now we see an output of just a dot (.). This is because our expected output, <code class="language-plaintext highlighter-rouge">HELLO!</code>, does indeed match the actual output.</p>

<p>We can organize our code better in different files, for example the <code class="language-plaintext highlighter-rouge">MySpec</code> framework in <code class="language-plaintext highlighter-rouge">my_spec.rb</code> and the <code class="language-plaintext highlighter-rouge">emphasize</code> method in <code class="language-plaintext highlighter-rouge">emphasize_spec.rb</code>.</p>

<p>In the next chapter we’re going to make our syntax more closely match the real RSpec syntax. In addition to our <code class="language-plaintext highlighter-rouge">expect</code>, we’re going to have surrounding <code class="language-plaintext highlighter-rouge">it</code> and <code class="language-plaintext highlighter-rouge">describe</code> blocks.</p>

<h3 id="chapter-23">Chapter 23. RSpec Syntax: Build Your Own RSpec, Part 2</h3>

<p>In the last chapter we got as far as re-implementing RSpec’s expect, <code class="language-plaintext highlighter-rouge">to</code> and <code class="language-plaintext highlighter-rouge">eq</code>.</p>

<p>Now let’s make our test look even more like a real RSpec test by implementing <code class="language-plaintext highlighter-rouge">describe</code> and <code class="language-plaintext highlighter-rouge">it</code>.</p>

<p>Within the file <code class="language-plaintext highlighter-rouge">emphasize_spec.rb</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./my_spec'</span>

<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
  
<span class="no">MySpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’ll start with just the inner part, the <code class="language-plaintext highlighter-rouge">it</code> block.</p>

<p>Now, if we run <code class="language-plaintext highlighter-rouge">emphasize_spec.rb</code>, we get the following <code class="language-plaintext highlighter-rouge">error</code>. The <code class="language-plaintext highlighter-rouge">it</code> method we referred to is of course undefined.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emphasize_spec</span><span class="p">.</span><span class="nf">rb</span><span class="p">:</span><span class="mi">27</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;': undefined method `</span><span class="n">it</span><span class="err">'</span> <span class="k">for</span> <span class="n">main</span><span class="ss">:Object</span> <span class="p">(</span><span class="no">NoMethodError</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s add the <code class="language-plaintext highlighter-rouge">it</code> method with a <code class="language-plaintext highlighter-rouge">yield</code> keyword since <code class="language-plaintext highlighter-rouge">it</code> block doesn’t actually need to do anything, it’s just a wrapper for the benefit of the human reader.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ExpectationTarget</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="vi">@output</span> <span class="o">=</span> <span class="n">output</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@output</span> <span class="o">==</span> <span class="n">expected_output</span>
      <span class="nb">puts</span> <span class="s1">'.'</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Expected </span><span class="si">#{</span><span class="vi">@output</span><span class="si">}</span><span class="s2"> to equal </span><span class="si">#{</span><span class="n">expected_output</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="no">ExpectationTarget</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
  <span class="n">expected_output</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">it</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
  <span class="k">yield</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Adding the outer block <code class="language-plaintext highlighter-rouge">MySpec.describe</code></p>

<p>Within <code class="language-plaintext highlighter-rouge">emphasize_spec.rb</code> we add the outer block and run the file.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./my_spec'</span>

<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="no">MySpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s1">'emphasizing text'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'makes the text uppercase and adds an exclamation point'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span><span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>the error is our friend and we have seen it many times before: <code class="language-plaintext highlighter-rouge">emphasize_spec.rb:31:in '&lt;main&gt;': uninitialized constant MySpec (NameError)</code></p>

<p>Let’s add that <code class="language-plaintext highlighter-rouge">MySpec</code> class.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySpec</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ExpectationTarget</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="vi">@output</span> <span class="o">=</span> <span class="n">output</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@output</span> <span class="o">==</span> <span class="n">expected_output</span>
      <span class="nb">puts</span> <span class="s1">'.'</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Expected </span><span class="si">#{</span><span class="vi">@output</span><span class="si">}</span><span class="s2"> to equal </span><span class="si">#{</span><span class="n">expected_output</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="no">ExpectationTarget</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
  <span class="n">expected_output</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">it</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
  <span class="k">yield</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>

</code></pre></div></div>

<p>If we run the file, we get the next error <code class="language-plaintext highlighter-rouge">emphasize_spec.rb:34:in '&lt;main&gt;': undefined method 'describe' for MySpec:Class (NoMethodError)</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySpec</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">describe</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="k">yield</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">emphasize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">text</span><span class="p">.</span><span class="nf">upcase</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ExpectationTarget</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="vi">@output</span> <span class="o">=</span> <span class="n">output</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@output</span> <span class="o">==</span> <span class="n">expected_output</span>
      <span class="nb">puts</span> <span class="s1">'.'</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Expected </span><span class="si">#{</span><span class="vi">@output</span><span class="si">}</span><span class="s2"> to equal </span><span class="si">#{</span><span class="n">expected_output</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
  <span class="no">ExpectationTarget</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">expected_output</span><span class="p">)</span>
  <span class="n">expected_output</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">it</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
  <span class="k">yield</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">emphasize</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'HELLO!'</span><span class="p">)</span>
</code></pre></div></div>

<p>Now everything works, and we now have a complete test that very much resembles an <code class="language-plaintext highlighter-rouge">RSpec</code> test!</p>

<h3 id="chapter-24">Chapter 24. RSpec Syntax: Describe and Context</h3>

<p>The <code class="language-plaintext highlighter-rouge">describe</code> and <code class="language-plaintext highlighter-rouge">context</code> keywords are just aliases for one another. Mechanically, they’re 100% equivalent. The only reason the two keywords exist is for the benefit of the human reader.</p>

<p>When I use <code class="language-plaintext highlighter-rouge">describe</code></p>

<p>I tend to use <code class="language-plaintext highlighter-rouge">describe</code> when I’m describing a <code class="language-plaintext highlighter-rouge">method</code> or a <code class="language-plaintext highlighter-rouge">feature</code>. If I were to write a test for a method called <code class="language-plaintext highlighter-rouge">first_name</code>, I might write it something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#first_name'</span> <span class="k">do</span> <span class="c1"># ⬅ here is the method first_name declared</span>
    <span class="n">it</span> <span class="s1">'returns the first name'</span> <span class="k">do</span>
      <span class="c1"># test code goes here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Sometimes I want to test a feature that doesn’t have a neat one-to-one relationship with a method.</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'phone format'</span> <span class="k">do</span> <span class="c1"># ⬅ here is the feature we test</span>
    <span class="n">it</span> <span class="s1">'strips the non-numeric characters'</span> <span class="k">do</span>
      <span class="c1"># test code goes here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When I use <code class="language-plaintext highlighter-rouge">context</code></p>

<p>I tend to use <code class="language-plaintext highlighter-rouge">context</code> when I want to test various permutations of a behavior.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span> <span class="c1"># ⬅ group example for User class</span>
  <span class="n">describe</span> <span class="s1">'phone format'</span> <span class="k">do</span> <span class="c1"># ⬅ describre block to group two nested blocks</span>
    <span class="n">context</span> <span class="s1">'phone number is not the right length'</span> <span class="k">do</span> <span class="c1"># ⬅ here a context block to describe a behavior</span>
      <span class="c1"># test code goes here</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'containers non-numeric characters'</span> <span class="k">do</span> <span class="c1"># ⬅ here a context block to describe a behavior</span>
      <span class="c1"># test code goes here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="chapter-31">Chapter 31. Model Specs: Introduction</h3>

<p>The purpose of model specs</p>

<p><b>Model specs are for testing the behavior of your application.</b> This may sound obvious, but many programmers seem to misunderstand the meaning of “behavior” and instead test the implementation of their application’s features, which unfortunately misses the point of testing altogether. Let’s talk about the difference between testing implementation and testing behavior.</p>

<p>Implementation vs. behavior</p>

<p>An example of an implementation test might be: “Does the Patient model have a <code class="language-plaintext highlighter-rouge">has_many :payment_entries</code> association?” If you look at <code class="language-plaintext highlighter-rouge">patient.rb</code> and it contains the line <code class="language-plaintext highlighter-rouge">has_many :payment_entries</code>, then the test passes.</p>

<p>An example of a behavior test might be <b>“When I add a payment entry for $50 for a patient, does the patient’s balance decrease by $50?”</b> To perform this test you might check the patient’s balance, see that it’s $80, then enter a $50 payment into the system and finally navigate to the patient’s profile and verify that the patient’s balance is now $30 instead of $80.</p>

<p>If you’ve verified that adding a $50 payment entry decreases a patient’s balance by $50, then you’ve also verified that a <code class="language-plaintext highlighter-rouge">has_many :payment_entries</code> association exists , since the feature can’t work without the <code class="language-plaintext highlighter-rouge">payment_entries</code> association. So having an additional test solely for the <code class="language-plaintext highlighter-rouge">payment_entries</code> association would be redundant and superfluous.</p>

<p>Notice how the behavior test has nothing to do with how the feature is actually coded. We don’t care how it works, we only care that it works.</p>

<p>Common errors of testing implementation instead of behavior</p>

<p>• Verifying that validations exist
• Verifying that associations exist
• Verifying that a class responds to certain methods
• Verifying that callbacks exist
• Verifying that a database table has certain columns and indexes</p>

<p>These are all examples of testing implementation rather than behavior. All such tests are quite frankly, pointless. Instead of testing these things directly, it’s more helpful to test the behaviors that these things enable.</p>

<p>The value of loose coupling</p>

<p>One benefit of testing behavior rather than implementation is loose coupling. Two things are loosely coupled to the degree that you can change one without having to change the other.</p>

<p>If you write tests that test implementation, you’ve guaranteed tight coupling. Loose coupling is only possible with tests that test behavior.</p>

<p>Testing that a model responds to certain methods</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">factory_instance</span><span class="p">).</span><span class="nf">to</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:public_method_name</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>There’s negligible value in simply testing that a model responds to a method. Better to test that that method does the right thing.</p>

<p>Testing for the presence of callbacks</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">to</span> <span class="n">callback</span><span class="p">(</span><span class="ss">:calculate_some_metrics</span><span class="p">).</span><span class="nf">after</span><span class="p">(</span><span class="ss">:save</span><span class="p">)</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">to</span> <span class="n">callback</span><span class="p">(</span><span class="ss">:track_new_user_signup</span><span class="p">).</span><span class="nf">after</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>Don’t verify that the callback got called. Verify that you got the result you expected the callback to produce.</p>

<p>Tips for writing valuable RSpec tests</p>

<p><b>Here’s how I tend to write model specs: for every method I create on a model, I try to poke at that method from every possible angle and make sure it returns the desired result.</b></p>

<p>For example, I recently added a feature in an application that made it impossible to schedule an appointment for a patient who has been inactivated. So I wrote three test cases:</p>
<ul>
  <li>one where the patient is active (expect success),</li>
  <li>one where the patient is inactive (expect an error to get added to the object),</li>
  <li>and one where the patient was missing altogether (expect a different error on the object).</li>
</ul>

<h3 id="chapter-32">Chapter 32. Model Specs: Tutorial, Part One</h3>

<p>It may seem obvious what a Rails model is. To many Rails developers, the model is the MVC layer that talks to the database.
But in my experience, there are actually a lot of different conceptions as to what Rails models are, and not all of them agree with each other. I think it’s important for us to firmly establish what a Rails model is before we start talking about how to test Rails models.</p>

<p><b>To me, a model is an abstraction that represents a small corner of reality in a simplified way.</b> Models exist to make it easier for a programmer to think about and work with the concepts in a program. Models are not a Rails idea or even an OOP idea. A model could be represented in any programming language and in any programming paradigm.</p>

<p>Why model specs are different from other types of specs</p>

<p>Because models aren’t a Rails idea but rather a programming idea, testing models in Rails isn’t that conceptually different from testing models in any other language or framework. In a way this is a great benefit to a learner because it means that if you know how to test models in one language, your testing skills will easily translate to any other language.</p>

<p>System specs are relatively easy to get started with because you can more or less follow a certain step-by-step formula for writing system specs for CRUD features and be well on your way. There’s not as much of a step-by-step formula for writing model tests</p>

<p>The tutorial</p>

<p>Here are the things you can expect to have a better understanding of after completing this tutorial.</p>

<ol>
  <li>How to come up with test cases for a model based on the model’s desired behavior.</li>
  <li>How to translate those test cases into actual working test code, in a methodical and repeatable manner.</li>
  <li>How to use a test-first approach to make it easier both to write the tests and to write the application code.</li>
</ol>

<p>The scenario</p>

<p>We want our phone number model to be able to take phone numbers in any of the following formats:</p>

<p>555-856-8075
(555) 856-8075
+1 555 856 8075</p>

<p>And strip them down to look like this:</p>

<p>5558568075</p>

<p>Our <code class="language-plaintext highlighter-rouge">PhoneNumber</code> class won’t know anything about databases, it will just be responsible for converting a “messy” phone number to a normalized one.</p>

<p>Our first test</p>

<p>A big part of the art of model testing is coming up with various scenarios and deciding how our code should behave under those scenarios.</p>

<p>The first scenario we’ll test here is: “When we have a phone number where the digits are separated by dashes, the dashes should all get stripped out.”</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./phone_number.rb'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">PhoneNumber</span> <span class="k">do</span>
  <span class="c1"># test for scenario 1</span>
  <span class="n">context</span> <span class="s2">"phone number contains dashes"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out the dashes"</span> <span class="k">do</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"555-856-8075"</span><span class="p">)</span>


    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># test for scenario 2</span>
  <span class="n">context</span> <span class="s2">"phone number contains parentheses"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out the non-numeric characters"</span> <span class="k">do</span>
      <span class="n">phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"(555) 856-8075"</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># test for scenario 3</span>
  <span class="n">context</span> <span class="s2">"phone number contains country code "</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out the country code"</span> <span class="k">do</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"+1 555 856 8075"</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">PhoneNumber</span>
  <span class="nb">attr_reader</span> <span class="ss">:value</span>

  <span class="no">EXPECTED_NUMBER_OF_DIGITS</span> <span class="o">=</span> <span class="mi">10</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="vi">@value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/\D/</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s2">""</span><span class="p">).</span><span class="nf">last</span><span class="p">(</span><span class="no">EXPECTED_NUMBER_OF_DIGITS</span><span class="p">).</span><span class="nf">join</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="chapter-33">Chapter 33. Model Specs: Tutorial, Part Two</h3>

<p>Learning objectives</p>

<ol>
  <li>How to come up with test cases for a model based on the model’s desired behavior.</li>
  <li>How to translate those test cases into actual working test code, in a methodical and repeatable manner.</li>
  <li>How to use a test-first approach to make it easier both to write the tests and to write the application code.</li>
</ol>

<p>The scenario</p>

<p>We’ll be working on the exact same scenario as Part One: normalizing messy phone numbers. We’ll even be using all the exact same test cases. The reason we’re keeping those things the same is to show the Rails-models-versus-POROs differences in sharp relief.</p>

<p>The <code class="language-plaintext highlighter-rouge">PhoneNumber</code> model</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">phone_number</span> <span class="n">value</span><span class="ss">:string</span>
<span class="err">$</span> <span class="n">rails</span> <span class="n">db</span><span class="ss">:migrate</span>

<span class="c1"># spec/models/phone_number_spec.rb</span>
<span class="nb">require</span> <span class="s2">"rails_helper"</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">PhoneNumber</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># Our first test case</span>
  <span class="n">context</span> <span class="s2">"phone number contains dashes"</span> <span class="ss">:model</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out the dashes"</span> <span class="k">do</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">"555-856-8075"</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Our second test case</span>
  <span class="n">context</span> <span class="s2">"phone number contains parentheses"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out non-numeric characters"</span> <span class="k">do</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">"(555) 856-8075"</span><span class="p">)</span>
    
    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Our third test case</span>
  <span class="n">context</span> <span class="s2">"phone number contains country code"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"strips out country code"</span> <span class="k">do</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">"+1 555 856 8075"</span><span class="p">)</span>
    
    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/phone_number.rb</span>
<span class="k">class</span> <span class="nc">PhoneNumber</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_validation</span> <span class="ss">:strip_non_numeric_from_value</span>

  <span class="no">EXPECTED_NUMBER_OF_DIGITS</span> <span class="o">=</span> <span class="mi">10</span>
  
  <span class="k">def</span> <span class="ss">:strip_non_numeric_from_value</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">value</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">value</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/\D/</span><span class="p">,</span> <span class="s2">""</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s2">""</span><span class="p">).</span><span class="nf">last</span><span class="p">(</span><span class="no">EXPECTED_NUMBER_OF_DIGITS</span><span class="p">).</span><span class="nf">join</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Refactoring</p>

<p>Rather than repeatedly creating a new <code class="language-plaintext highlighter-rouge">phone_number</code> variable using <code class="language-plaintext highlighter-rouge">FactoryBot.create</code>, we can DRY up our code a little by putting the <code class="language-plaintext highlighter-rouge">FactoryBot.create</code> in a <code class="language-plaintext highlighter-rouge">let!</code> block at the beginning and then updating the phone number value for each test.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rails_helper"</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">PhoneNumber</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:phone_number</span><span class="p">)</span>
  <span class="k">end</span>

<span class="n">context</span> <span class="s2">"phone number contains dashes"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">phone_number</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">value: </span><span class="s2">"555-856-8075"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="s2">"strips out the dashes"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">context</span> <span class="s2">"phone number contains parentheses"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">phone_number</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">value: </span><span class="s2">"(555) 856-8075"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="s2">"strips out the non-numeric characters"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">context</span> <span class="s2">"phone number contains country code"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">phone_number</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">value: </span><span class="s2">"+1 555 856 8075"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="s2">"strips out the country code"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">phone_number</span><span class="p">.</span><span class="nf">value</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"5558568075"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Takeaways
Rails model tests can be written by coming up with a list of desired behaviors and translating that list into test code.</p>

<p>When learning how to write Rails model tests, it can be helpful to first do some tests with plain old Ruby objects (<code class="language-plaintext highlighter-rouge">POROs</code>) for practice.</p>

<p>Writing tests before we write the application code can make the process of writing the application code easier.</p>
</div>


<div class='breaker'></div>

<h3>Details</h3>
<ul itemprop="itemReviewed" itemscope itemtype="http://schema.org/Book">
  <li><span itemprop=name>The Beginner’s Guide to Rails Testing Jason Swett</span> by <span itemprop=author>Jason Swett.</span></li>

  
  

  <li>Published: <span itemprop=datePublished>2022</span></li>
  
</ul>

  <div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="dominiclizarraga.github.io">
    <meta itemprop="url" content="http://localhost:4000">
  </div>
  <meta itemprop="author" content="dom lizarraga">
  <meta itemprop="url" content="http://localhost:4000/2022/02/14/test_jason_swett.html">

</div>

<div class="mobile-only-button">
  <!-- <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="domlizarrraga" data-color="#5F7FFF" data-emoji="🍕" data-font="Comic" data-text="Buy me a pizza" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00" ></script> -->
</div>

<script src="https://giscus.app/client.js"
        data-repo="dominiclizarraga/dominiclizarraga.github.io"
        data-repo-id="R_kgDOJ601Dg"
        data-category="General"
        data-category-id="DIC_kwDOJ601Ds4CliRX"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    </div>
  </div>
  <script>
    // 80s light switch click sound using Web Audio API
    function playClickSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gain = ctx.createGain();

        oscillator.connect(gain);
        gain.connect(ctx.destination);

        oscillator.frequency.setValueAtTime(1800, ctx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.03);

        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);

        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.05);
      } catch (e) {}
    }

    function toggleTheme() {
      playClickSound();
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateLabel(next);
    }

    function updateLabel(theme) {
      const label = document.querySelector('.theme-icon');
      if (label) {
        label.textContent = theme === 'dark' ? 'light' : 'dark';
      }
    }

    // Set correct label on load
    document.addEventListener('DOMContentLoaded', function() {
      const theme = document.documentElement.getAttribute('data-theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      updateLabel(theme);
    });
  </script>
</body>
</html>
