<!doctype html>
<html lang=en>
<head>
  <meta charset=utf-8>
  <meta name=author content='dom lizarraga' />
  <meta name='theme-color' content='#fff' />
  <meta name='twitter:title' content="N + 1 queries and how to fix them." />
  <meta name=description content="" />
  <meta name=viewport content='width=device-width,minimum-scale=1'>
  <meta property='og:site_name' content="dominiclizarraga.github.io"/>
  <meta property='og:email' content="dominiclizarraga@hotmail.com"/>
  <meta property='og:type' content=blog />
  <meta property='twitter:account_id' content=domlizarraga_ />
  
  
  <script type='application/ld+json'>{"@context": "http://schema.org","@type": "CreativeWork","author": "dom lizarraga"}</script>
  
    <link rel=alternate type='application/rss+xml' title="dominiclizarraga.github.io" href="http://localhost:4000/rss.xml" />
    <link rel=alternate type='application/atom+xml' title="dominiclizarraga.github.io" href="http://localhost:4000/atom.xml" />
  
  <link rel=icon type=image/x-icon href=/css/favicon.png />
  <style>:root {
  --mono-font: San Francisco Mono, Monaco, "Consolas", "Lucida Console",
    "DejaVu Sans Mono", "Bitstream Vera Sans Mono", monospace;
  --sans-font: -apple-system, BlinkMacSystemFont, "avenir next", avenir,
    helvetica, "helvetica neue", ubuntu, roboto, noto, "segoe ui", arial,
    sans-serif;
}

.star {
  width: 13px;
  height: 12px;
  display: inline-block;
  background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTMiIGhlaWdodD0iMTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTYuMzA5IDkuMjJMMi40MDkgMTJsMS40NC00LjU2N0wwIDQuNTgzbDQuNzg4LS4wNDJMNi4zMDggMCA3LjgzIDQuNTRsNC43ODkuMDQ0LTMuODUgMi44NDlMMTAuMjA5IDEyeiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+");
}

body {
  color: #111;
  margin: 0px auto;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  line-height: 1.6;
  font-size: 1rem;
  font-family: var(--sans-font);
  background-color: #f1e4c1;
}

/* Print tweaks ------------------------------------------------------------- */
.only-print {
  display: none;
}

.notitle .body p:first-child {
  margin-top: 0.25rem;
}

.body img {
  width: 100%;
  max-width: 640px;
}

/* Element styles ----------------------------------------------------------- */
sup,
sub {
  vertical-align: baseline;
  position: relative;
  top: -0.4em;
}

sub {
  top: 0.4em;
}

a {
  color: #000;
  text-decoration-skip-ink: auto;
  text-decoration: underline;
}

a:visited {
  color: #333;
}

ol,
ul {
  margin: 1rem 0;
}

ul ul {
  margin: 0;
}

ol li ul {
  margin: 5px 10px;
}

iframe {
  border: 0;
}

small,
.small {
  font-size: 14px;
}

br {
  line-height: 1em;
}

h1 a {
  color: #111;
}

em {
  font-style: italic;
}

h1 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 32px;
  letter-spacing: 0.004em;
}

h2 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1.5rem;
  letter-spacing: 0.009em;
}

h3 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1.25rem;
  letter-spacing: 0.009em;
}

h4 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 1rem;
}

h5 {
  margin-bottom: 0.5rem;
  line-height: 1.25;
  font-weight: 600;
  font-size: 0.875rem;
}

p {
  margin: 1rem 0;
}

blockquote {
  font-size: 16px;
  line-height: 25px;
}

td {
  vertical-align: top;
}

hr {
  background: #000;
  height: 1px;
  border: 0;
}

summary {
  cursor: pointer;
}

.body table {
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
}

.body th {
  text-align: left;
}

.body td,
.body th {
  padding: 0.5rem;
}

.body td {
  border: 1px solid #cfcfcf;
}

.limiter {
  max-width: 640px;
  padding-left: 20px;
  padding-right: 20px;
  margin-left: auto;
  margin-right: auto;
}

/* Padding --------------------------------------- */
.pad2y {
  padding-top: 20px;
  padding-bottom: 20px;
}

span.image-credit {
  float: right;
  margin: 0 0 10px 10px;
  font-size: 12px;
}

span.image-credit:before {
  content: "↑";
  margin-right: 5px;
}

figcaption {
  font-size: 11px;
  text-align: center;
  font-size: 0.8rem;
  margin-top: -1.2rem;
}

div.post blockquote p {
  margin: 0;
}

/** Writing ----------------------------------------------------------------- */
.writing,
.books {
  display: grid;
  grid-column-gap: 5px;
  grid-row-gap: 5px;
}

.writing {
  grid-template-columns: 1fr min-content;
}

.books {
  grid-template-columns: 1fr 0.75fr min-content 70px;
}

.writing a,
.books a {
  font-weight: 500;
  letter-spacing: -0.015em;
}

.writing > div,
.books > div {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.writing time,
.books time {
  padding-right: 0.25em;
  color: #333;
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.012em;
  white-space: pre;
}

.project-box {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-gap: 30px;
}

.project-box a.project {
  text-decoration: none;
  color: #666;
}
.project-box a.project:hover {
  color: #000;
}
.project-box a.project img {
  display: block;
  margin-bottom: 10px;
}

/** Responsive -------------------------------------------------------------- */

@media screen and (max-width: 480px) {
  .project-box {
    grid-template-columns: repeat(1, 1fr);
  }
}

@media screen and (max-width: 640px) {
  .limiter {
    width: auto;
  }
  .project-box {
    grid-template-columns: repeat(2, 1fr);
  }
  .writing,
  .books {
    grid-template-columns: 1fr;
    grid-row-gap: 0px;
  }

  .writing div,
  .books div {
    white-space: normal;
  }

  .writing time,
  .books div:nth-child(4n) {
    padding-bottom: 20px;
  }
}

@media screen and (min-width: 640px) {
  .nu a {
    text-decoration: none;
  }

  .nu a:hover {
    text-decoration: underline;
  }
}

@media screen and (max-width: 1024px) {
  .header-wrap {
    border-bottom: 1px solid #000;
    padding-bottom: 20px;
  }
  .sigil {
    display: none;
  }
}

@media screen and (min-width: 1025px) {
  .header {
    position: absolute;
    top: 40px;
    right: 50%;
    margin-right: 340px !important;
    letter-spacing: -0.009em;
  }
  .content h1:first-child {
    margin-top: 0;
  }
}

@media print {
  .no-print {
    display: none;
  }
  .only-print {
    display: block;
  }
  body {
    margin: 0;
  }
  .limiter {
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
}

/** Code highlighting ------------------------------------------------------- */
p code,
pre code,
li code,
g.highlight,
.code {
  font-family: var(--mono-font);
}

p code {
  font-size: 90%;
}

pre code {
  font-size: 0.8rem;
  line-height: 1.5;
}

.highlight,
blockquote {
  overflow-x: auto;
  padding: 10px 20px;
  margin: 0;
  background: #fff;
  border-radius: 10px;
}

blockquote {
  font-style: italic;
}

blockquote p:first-child {
  margin-top: 0;
}

blockquote p:last-child {
  margin-bottom: 0;
}

/* pygments theme. does not support generics. .highlight class omitted */
.highlight {
  margin: 10px 0;
}

.highlight .hll {
  background-color: #ffffcc;
}

.c, /* Comment */
.cm, /* Comment.Multiline */
.cp, /* Comment.Preproc */
.cs, /* Comment.Special */
.c1 {
  color: #999988;
} /* Comment.Single */

.o, /* Operator */
.ow, /* Operator.Word */
.ge {
  color: #000000;
} /* Generic.Emph */

.kc, /* Keyword.Constant */
.kd, /* Keyword.Declaration */
.kn, /* Keyword.Namespace */
.kp, /* Keyword.Pseudo */
.kr, /* Keyword.Reserved */
.kt {
  color: #445588;
} /* Keyword.Type */

.err {
  color: #a61717;
} /* Error */

.m {
  color: #007f7f;
} /* Literal.Number */
.s {
  color: #d01040;
} /* Literal.String */

.na, /* Name.Attribute */
.nb, /* Name.Builtin */
.nc, /* Name.Class */
.no, /* Name.Constant */
.nd, /* Name.Decorator */
.ni, /* Name.Entity */
.ne, /* Name.Exception */
.nf, /* Name.Function */
.nn, /* Name.Namespace */
.nt, /* Name.Tag */
.nl {
  color: #990000;
} /* Name.Label */

.k, /* Keyword */
.nv {
  color: #008080;
} /* Name.Variable */

.mf, /* Literal.Number.Float */
.mh, /* Literal.Number.Hex */
.mi, /* Literal.Number.Integer */
.mo {
  color: #009999;
} /* Literal.Number.Oct */

.sb, /* Literal.String.Backtick */
.sc, /* Literal.String.Char */
.sd, /* Literal.String.Doc */
.s2, /* Literal.String.Double */
.se, /* Literal.String.Escape */
.sh, /* Literal.String.Heredoc */
.s1, /* Literal.String.Single */
.si, /* Literal.String.Interpol */
.ss, /* Literal.String.Symbol */
.bp, /* Name.Builtin.Pseudo */
.sx {
  color: #d01040;
} /* Literal.String.Other */

.sr, /* Literal.String.Regex */
.vc, /* Name.Variable.Class */
.vg, /* Name.Variable.Global */
.vi, /* Name.Variable.Instance */
.il {
  color: #009999;
} /* Literal.Number.Integer.Long */

.mobile-only-button {
  display: none;
}

@media screen and (max-width: 480px) {
  .mobile-only-button {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 50px;
  }
  
  /* Style for the generated iframe */
  .mobile-only-button iframe {
    margin: 0 auto;
  }
}</style>
  <title>N + 1 queries and how to fix them. - dominiclizarraga.github.io</title>
  
  <link rel="canonical" href="http://localhost:4000/2023/12/06/n-+-1-queries.html">
  <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="domlizarrraga" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</head>
<body>
  <div class='pad2y' style='position:relative'>
    
    <div class='only-print'>
      <h2>dom lizarraga</h2>
      <div style='margin-top:0;'>dominiclizarraga@hotmail.com</div>
    </div>
    <nav class='header-wrap'>
      <div class='header nu limiter no-print'>
        <h1 style='line-height:1.6;font-size:1rem;margin:0 0 0.25em 0;'>dom lizarraga</h1>
        <ul style='list-style:none;padding:0;margin:0;'>
          <li style='margin:0.5rem 0;'><a href='/'>Notes</a>⇠</li>
          <li style='margin:0.5rem 0;'><a href='/reading/'>Reading</a></li>
          <li style='margin:0.5rem 0;'><a href='/projects/'>Projects</a></li>
          <li style='margin:0.5rem 0;'><a href='/computer_science/'>Computer <br>Science</a></li>
          <li style='margin:0.5rem 0;'><a href='/confs/'>Confs</a></li>
          <li style='margin:0.5rem 0;'><a href='/about/'>About</a></li>
        </ul>
      </div>
    </nav>
    <div class='pad2y limiter content '>
      <h1>N + 1 queries and how to fix them.</h1>
<div class='body'><p><strong>I recently had to deal with a n + 1 query….</strong></p>

<p>Firstly let’s understand why does this happen?</p>

<p>The N+1 query problem is like inviting friends to a party and then calling each one separately to ask if they’re coming. If you have 10 friends, you make 1 call to decide to invite them and then 10 more calls to each friend. So, for 10 friends, you make 11 calls in total.</p>

<p>In databases, this is like fetching a list of items (like blog posts), and then for each item, making another query to fetch related data (like comments on each post). If you have 10 posts and you fetch comments for each one by one, you end up making 1 query to get all posts plus 10 more queries for comments, leading to 11 queries.</p>

<p>But why in db happens this??</p>

<p>The First Query (N): When you ask for the list of posts, the ORM makes one query to fetch all posts. This is your “N” part of the problem, where “N” is the number of posts.</p>

<p>The Plus One (+1) Part: For each post, when you try to access its comments, the ORM realizes it hasn’t fetched those yet. So, it makes a new query for each post to fetch its comments. If you have 10 posts, this approach results in 10 additional queries - one for each post to get its comments.</p>

<p>The ORM’s default behavior is to load data on demand (lazy loading). It avoids fetching related data until you explicitly access it, which can be efficient in scenarios where the related data is not needed. However, when you do need related data for each item in a list, it leads to multiple queries, creating the N+1 problem.</p>

<p>Example:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rails console</span>
<span class="vi">@events</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">all</span>
  <span class="no">Event</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.5</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">"events"</span><span class="p">.</span><span class="nf">*</span> 
  <span class="no">FROM</span> <span class="s2">"events"</span> <span class="o">/*</span> <span class="n">loading</span> <span class="k">for</span> <span class="n">pp</span> <span class="o">*</span><span class="sr">/ LIMIT ?  [["LIMIT", 11]]

# Each call to `event.attendees` for an `event` triggers a separate query to fetch the `attendees` for just that `event`.

@events.each do |event|
  puts "Event: </span><span class="si">#{</span><span class="n">event</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="sr">"
  👉event.attendees.each do |attendee|
    puts "  Attendee: </span><span class="si">#{</span><span class="n">attendee</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="sr">"
  end
end
# Logs:
👉Event Load (0.2ms)  SELECT "events".* FROM "events"
  Event: Tech Conference
  👉Attendee Load (0.1ms)  SELECT "attendees".* FROM "attendees" INNER JOIN "registrations" ON "attendees"."id" = "registrations"."attendee_id" WHERE "registrations"."event_id" = ?  [["event_id", 1]]
    Attendee: Alice
    Attendee: Bob
    Attendee: Charlie
  Event: Music Festival
  👉Attendee Load (0.0ms)  SELECT "attendees".* FROM "attendees" INNER JOIN "registrations" ON "attendees"."id" = "registrations"."attendee_id" WHERE "registrations"."event_id" = ?  [["event_id", 2]]
    Attendee: Bob
    Attendee: Dana
</span></code></pre></div></div>

<p>Data to recreate a small excercise:</p>

<p>Let’s create a small app so we can see in detail what is being produced by each active record method.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create app with name `preload_demo_app`</span>
<span class="n">rails</span> <span class="n">new</span> <span class="n">preload_demo_app</span>
<span class="c1"># Go to `preload_demo_app` dir</span>
<span class="n">cd</span> <span class="n">preload_demo_app</span>
</code></pre></div></div>
<p>Then let’s create models and add the associations we need needed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create `Event` model</span>
<span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Event</span> <span class="nb">name</span><span class="ss">:string</span> <span class="n">location</span><span class="ss">:string</span> <span class="n">start_time</span><span class="ss">:datetime</span>
<span class="c1"># Create `Attendee` model</span>
<span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Attendee</span> <span class="nb">name</span><span class="ss">:string</span>
<span class="c1"># Create `Registration` model</span>
<span class="n">rails</span> <span class="n">generate</span> <span class="n">model</span> <span class="no">Registration</span> <span class="n">event</span><span class="ss">:references</span> <span class="n">attendee</span><span class="ss">:references</span>
</code></pre></div></div>
<p>Active Record Associations 👇</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:registrations</span>
  <span class="n">has_many</span> <span class="ss">:attendees</span><span class="p">,</span> <span class="ss">through: :registrations</span>
<span class="k">end</span>
<span class="c1"># app/models/attendee.rb</span>
<span class="k">class</span> <span class="nc">Attendee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:registrations</span>
  <span class="n">has_many</span> <span class="ss">:events</span><span class="p">,</span> <span class="ss">through: :registrations</span>
<span class="k">end</span>
<span class="c1"># app/models/registration.rb</span>
<span class="k">class</span> <span class="nc">Registration</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:event</span>
  <span class="n">belongs_to</span> <span class="ss">:attendee</span>
<span class="k">end</span>
</code></pre></div></div>
<p>One last step, we need some data to play with:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># events</span>
<span class="n">event1</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Tech Conference"</span><span class="p">,</span> <span class="ss">location: </span><span class="s2">"Conference Center"</span><span class="p">,</span> <span class="ss">start_time: </span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">event2</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Music Festival"</span><span class="p">,</span> <span class="ss">location: </span><span class="s2">"Outdoor Park"</span><span class="p">,</span> <span class="ss">start_time: </span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># attendees</span>
<span class="n">attendee1</span> <span class="o">=</span> <span class="no">Attendee</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Alice"</span><span class="p">)</span>
<span class="n">attendee2</span> <span class="o">=</span> <span class="no">Attendee</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Bob"</span><span class="p">)</span>
<span class="n">attendee3</span> <span class="o">=</span> <span class="no">Attendee</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Charlie"</span><span class="p">)</span>
<span class="n">attendee4</span> <span class="o">=</span> <span class="no">Attendee</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Dana"</span><span class="p">)</span>

<span class="c1"># registrations </span>
<span class="no">Registration</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">event: </span><span class="n">event1</span><span class="p">,</span> <span class="ss">attendee: </span><span class="n">attendee1</span><span class="p">)</span>
<span class="no">Registration</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">event: </span><span class="n">event1</span><span class="p">,</span> <span class="ss">attendee: </span><span class="n">attendee2</span><span class="p">)</span>
<span class="no">Registration</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">event: </span><span class="n">event1</span><span class="p">,</span> <span class="ss">attendee: </span><span class="n">attendee3</span><span class="p">)</span>
<span class="no">Registration</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">event: </span><span class="n">event2</span><span class="p">,</span> <span class="ss">attendee: </span><span class="n">attendee2</span><span class="p">)</span>
<span class="no">Registration</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">event: </span><span class="n">event2</span><span class="p">,</span> <span class="ss">attendee: </span><span class="n">attendee4</span><span class="p">)</span>
</code></pre></div></div>
<p>With this in place we can start playing with the model by opening ‘<code class="language-plaintext highlighter-rouge">rails c</code>’</p>

<p>🔺 Let’s see <code class="language-plaintext highlighter-rouge">includes</code> behavior:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># `.includes` is designed to minimize the number of queries and the overall load on the database by preloading associated data</span>
<span class="no">Event</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:attendees</span><span class="p">)</span>
  <span class="c1"># See the `IN` SQL keyword in the query for both `registrations` and `attendees`</span>
  <span class="c1"># A single SQL query that retrieves both in a single database roundtrip.</span>
  <span class="no">Event</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">"events"</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="s2">"events"</span> <span class="o">/*</span> <span class="n">loading</span> <span class="k">for</span> <span class="n">pp</span> <span class="o">*</span><span class="sr">/ LIMIT ?  [["LIMIT", 11]]
    Registration Load (0.4ms)  SELECT "registrations".* FROM "registrations" 
      WHERE "registrations"."event_id" IN (?, ?)  [["event_id", 1], ["event_id", 2]]
    Attendee Load (0.1ms)  SELECT "attendees".* FROM "attendees" 
      WHERE "attendees"."id" IN (?, ?, ?, ?)  [["id", 1], ["id", 2], ["id", 3], ["id", 4]]
</span></code></pre></div></div>

<p>🔺 Now <code class="language-plaintext highlighter-rouge">preload</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">preload</span><span class="p">(</span><span class="ss">:attendees</span><span class="p">)</span>
  <span class="c1"># See the `IN` SQL keyword as well, here the key difference is how you apply the `.where`</span>
  <span class="no">Event</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">"events"</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="s2">"events"</span> <span class="o">/*</span> <span class="n">loading</span> <span class="k">for</span> <span class="n">pp</span> <span class="o">*</span><span class="sr">/ LIMIT ?  [["LIMIT", 11]]
  Registration Load (0.3ms)  SELECT "registrations".* FROM "registrations" 
  WHERE "registrations"."event_id" IN (?, ?)  [["event_id", 1], ["event_id", 2]]
  Attendee Load (0.1ms)  SELECT "attendees".* FROM "attendees" 
  WHERE "attendees"."id" IN (?, ?, ?, ?)  [["id", 1], ["id", 2], ["id", 3], ["id", 4]]
</span></code></pre></div></div>

<p>🔺 <code class="language-plaintext highlighter-rouge">eager_load</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">eager_load</span><span class="p">(</span><span class="ss">:attendees</span><span class="p">)</span>
  <span class="c1"># See the LEFT OUTER JOIN, it ensures that even `events` without any attendees are included in the result</span>
  <span class="no">SQL</span> <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="no">DISTINCT</span> <span class="s2">"events"</span><span class="o">.</span><span class="s2">"id"</span> <span class="no">FROM</span> <span class="s2">"events"</span> 
  <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">"registrations"</span> <span class="no">ON</span> <span class="s2">"registrations"</span><span class="o">.</span><span class="s2">"event_id"</span> <span class="o">=</span> <span class="s2">"events"</span><span class="o">.</span><span class="s2">"id"</span> 
  <span class="no">LEFT</span> <span class="no">OUTER</span> <span class="no">JOIN</span> <span class="s2">"attendees"</span> <span class="no">ON</span> <span class="s2">"attendees"</span><span class="o">.</span><span class="s2">"id"</span> <span class="o">=</span> <span class="s2">"registrations"</span><span class="o">.</span><span class="s2">"attendee_id"</span> <span class="o">/*</span> <span class="n">loading</span> <span class="k">for</span> <span class="n">pp</span> <span class="o">*</span><span class="sr">/ LIMIT ?  [["LIMIT", 11]]
  SQL (0.1ms)  SELECT "events"."id" AS t0_r0, "events"."name" AS t0_r1, "events"."location" AS t0_r2,
   "events"."start_time" AS t0_r3, "events"."created_at" AS t0_r4, "events"."updated_at" AS t0_r5,
    "attendees"."id" AS t1_r0, "attendees"."name" AS t1_r1, "attendees"."created_at" AS t1_r2, 
    "attendees"."updated_at" AS t1_r3 FROM "events" LEFT OUTER JOIN "registrations" 
    ON "registrations"."event_id" = "events"."id" LEFT OUTER JOIN "attendees" 
    ON "attendees"."id" = "registrations"."attendee_id" WHERE "events"."id" 
    IN (?, ?) /</span><span class="o">*</span> <span class="n">loading</span> <span class="k">for</span> <span class="n">pp</span> <span class="o">*</span><span class="sr">/  [["id", 1], ["id", 2]]
</span></code></pre></div></div>

<p>🔺 What happens with <code class="language-plaintext highlighter-rouge">.joins</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Tech Conference"</span><span class="p">)</span>
<span class="no">Event</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">"events"</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="s2">"events"</span> <span class="no">WHERE</span> <span class="s2">"events"</span><span class="o">.</span><span class="s2">"name"</span> <span class="o">=</span> <span class="p">?</span> <span class="no">LIMIT</span> <span class="p">?</span>  <span class="p">[[</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"Tech Conference"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="c1"># Usage of `.joins`</span>
<span class="no">Attendee</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:registrations</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">registrations: </span><span class="p">{</span><span class="ss">event_id: </span><span class="n">event</span><span class="p">.</span><span class="nf">id</span><span class="p">})</span>
  <span class="c1"># an `INNER JOIN` is performed between `attendees` and `registrations`. </span>
  <span class="c1"># It uses the association named `registrations` defined in the `Attendee` model.</span>
  <span class="no">Attendee</span> <span class="no">Load</span> <span class="p">(</span><span class="mf">0.2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">"attendees"</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="s2">"attendees"</span> 
  <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">"registrations"</span> <span class="no">ON</span> <span class="s2">"registrations"</span><span class="o">.</span><span class="s2">"attendee_id"</span> <span class="o">=</span> <span class="s2">"attendees"</span><span class="o">.</span><span class="s2">"id"</span> 
  <span class="no">WHERE</span> <span class="s2">"registrations"</span><span class="o">.</span><span class="s2">"event_id"</span> <span class="o">=</span> <span class="p">?</span> <span class="sr">/* loading for pp */</span> <span class="no">LIMIT</span> <span class="p">?</span>  <span class="p">[[</span><span class="s2">"event_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">"LIMIT"</span><span class="p">,</span> <span class="mi">11</span><span class="p">]]</span>

<span class="no">Event</span><span class="p">.</span><span class="nf">joins</span><span class="p">(:</span><span class="n">registrations</span><span class="p">).</span><span class="nf">distinct</span>
  <span class="c1"># See the `DISTINCT` in the `SELECT` statement (ensures that events are listed uniquely).</span>
  <span class="no">SELECT</span> <span class="no">DISTINCT</span> <span class="s2">"events"</span><span class="p">.</span><span class="nf">*</span> <span class="no">FROM</span> <span class="s2">"events"</span> 
  <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">"registrations"</span> <span class="no">ON</span> <span class="s2">"registrations"</span><span class="o">.</span><span class="s2">"event_id"</span> <span class="o">=</span> <span class="s2">"events"</span><span class="o">.</span><span class="s2">"id"</span> 
</code></pre></div></div>

<p>Summary:</p>

<div><img src="/graphics/projects/n_+_1.png" alt="n + 1 table" style="width:900px;" /></div>

<p>Hope you get more understanding on this topic!</p>

<p>More blog posts here: 👇</p>

<p><a href="https://theleafnode.com/active-record-includes-and-n-plus-1-query-problem-2/">Bhumi’s N + 1 blog post</a><br />
<a href="https://codedecoder.wordpress.com/2014/07/23/eager-loading-eager_load-preload-includes/">arunyadav N + 1</a><br />
<a href="https://bhserna.gumroad.com/l/fix-n-1-queries-on-rails?layout=profile&amp;recommended_by=library">Benito Serna N + 1 ebook</a><br />
<br />
So you need a sort at database level or just with ruby is enough?</p>
</div>

<div class='breaker'></div>

<div class='pad2y'>
  <p>
    <postamble datetime="2023-12-06">
      December  6, 2023
    </postamble>
    &nbsp;
    <a href="https://twitter.com/intent/follow?screen_name=domlizarraga_&user_id=domlizarraga_" rel="nofollow" rel="noopener" target="_blank" title="Follow me on Twitter">
      @domlizarraga_
    </a>
  </p>
</div>

<div class="mobile-only-button">
  <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="domlizarrraga" data-color="#5F7FFF" data-emoji="🍕" data-font="Comic" data-text="Buy me a pizza" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00" ></script>
</div>

<script src="https://giscus.app/client.js"
        data-repo="dominiclizarraga/dominiclizarraga.github.io"
        data-repo-id="R_kgDOJ601Dg"
        data-category="General"
        data-category-id="DIC_kwDOJ601Ds4CliRX"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    </div>
  </div>
</body>
</html>
