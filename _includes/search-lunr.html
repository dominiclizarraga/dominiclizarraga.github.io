<div class="search-wrapper">
  <form class="search-form" onSubmit="return initSearchAndQuery(document.getElementById('lunrsearch').value);">
    <input
      type="text"
      class="search-input"
      id="lunrsearch"
      name="q"
      maxlength="120"
      placeholder="Search"
    />
  </form>
</div>

<div id="lunrsearchresults" class="search-results"></div>

<script>
var searchIndex = null;
var searchDocuments = null;
var lunrLoaded = false;

function loadLunr(callback) {
  if (lunrLoaded) {
    callback();
    return;
  }
  var script = document.createElement('script');
  script.src = '/js/lunr.js';
  script.onload = function() {
    lunrLoaded = true;
    callback();
  };
  document.head.appendChild(script);
}

function loadSearchIndex(callback) {
  if (searchDocuments) {
    callback();
    return;
  }
  fetch('/search-index.json')
    .then(function(response) { return response.json(); })
    .then(function(data) {
      searchDocuments = data;
      callback();
    })
    .catch(function(err) {
      console.error('Failed to load search index:', err);
      document.getElementById('lunrsearchresults').innerHTML = '<p class="search-error">Search unavailable</p>';
    });
}

function buildIndex() {
  if (searchIndex) return;
  searchIndex = lunr(function () {
    this.ref('id');
    this.field('title', { boost: 10 });
    this.field('body');
    var self = this;
    searchDocuments.forEach(function (doc) {
      self.add(doc);
    });
  });
}

function performSearch(term) {
  var resultsEl = document.getElementById('lunrsearchresults');

  if (!term) {
    resultsEl.innerHTML = '';
    resultsEl.classList.remove('has-results');
    return false;
  }

  var results = searchIndex.search(term);

  var html = '<div class="search-results-header">Results for "' + term + '"';
  html += '<button class="search-close" onclick="closeSearch()">&times;</button></div>';
  html += '<ul class="search-results-list">';

  if (results.length > 0) {
    for (var i = 0; i < results.length; i++) {
      var ref = results[i]['ref'];
      var doc = searchDocuments.find(function(d) { return d.id == ref; });
      if (doc) {
        var body = doc.body.substring(0, 120) + '...';
        html += '<li class="search-result-item">';
        html += '<a href="' + doc.url + '">';
        html += '<span class="search-result-title">' + doc.title + '</span>';
        html += '<span class="search-result-body">' + body + '</span>';
        html += '</a></li>';
      }
    }
  } else {
    html += '<li class="search-result-item no-results">No results found</li>';
  }

  html += '</ul>';
  resultsEl.innerHTML = html;
  resultsEl.classList.add('has-results');
  return false;
}

function closeSearch() {
  var resultsEl = document.getElementById('lunrsearchresults');
  resultsEl.innerHTML = '';
  resultsEl.classList.remove('has-results');
  document.getElementById('lunrsearch').value = '';
}

function initSearchAndQuery(term) {
  var resultsEl = document.getElementById('lunrsearchresults');
  resultsEl.innerHTML = '<p class="search-loading">Searching...</p>';
  resultsEl.classList.add('has-results');

  loadLunr(function() {
    loadSearchIndex(function() {
      buildIndex();
      performSearch(term);
    });
  });
  return false;
}
</script>
